name: Merge and Release

on:
  push:
    branches:
      - 'claude/**'
    paths:
      - '.github/workflows/merge-and-release.yml'

jobs:
  merge-to-master:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create PR and merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          echo "=== Creating PR from ${BRANCH_NAME} to master ==="

          # Check for existing open PR
          EXISTING=$(gh pr list --head "${BRANCH_NAME}" --state open --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING" ]; then
            echo "Open PR #${EXISTING} already exists, merging it..."
            PR_NUM=$EXISTING
          else
            echo "Creating new PR..."
            gh pr create \
              --title "Merge ${BRANCH_NAME} to master" \
              --body "Auto-merge from ${BRANCH_NAME}" \
              --base master \
              --head "${BRANCH_NAME}" 2>&1

            PR_NUM=$(gh pr list --head "${BRANCH_NAME}" --state open --json number --jq '.[0].number')
            echo "Created PR #${PR_NUM}"
          fi

          # Enable auto-merge (squash)
          echo "Merging PR #${PR_NUM}..."
          gh pr merge "${PR_NUM}" --squash --auto --delete-branch 2>/dev/null || \
          gh pr merge "${PR_NUM}" --squash --admin 2>/dev/null || \
          gh pr merge "${PR_NUM}" --merge --admin 2>/dev/null || {
            echo "Could not auto-merge, trying direct merge..."
            # Fallback: merge directly via git
            git fetch origin master
            git checkout master
            git merge "origin/${BRANCH_NAME}" --no-edit
            git push origin master
          }

          echo "=== Merge complete ==="

  create-release:
    needs: merge-to-master
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Create tag and release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract version from constants.py
          VERSION=$(grep '__version__' backend/constants.py | grep -oP '"\K[^"]+')
          TAG="v${VERSION}"

          echo "Creating release for ${TAG}..."

          # Check if tag already exists
          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists, deleting and recreating..."
            git tag -d "${TAG}" 2>/dev/null || true
            git push origin ":refs/tags/${TAG}" 2>/dev/null || true
          fi

          # Create and push tag
          git tag -a "${TAG}" -m "Certify Intel ${TAG}"
          git push origin "${TAG}"

          # Create release (the release.yml workflow will also fire, but this ensures it)
          gh release create "${TAG}" \
            --title "Certify Intel ${TAG}" \
            --generate-notes \
            --latest 2>/dev/null || echo "Release may already exist from release.yml"

          echo "=== Release ${TAG} created ==="
