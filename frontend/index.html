<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certify Intel - Competitive Intelligence Dashboard</title>

    <!-- Force service worker cache purge on version mismatch (inline so SW can't intercept) -->
    <script>
    (function() {
        var EXPECTED = 'v10.0.0';
        var stored = localStorage.getItem('sw_cache_version');
        if (stored && stored !== EXPECTED && 'serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(regs) {
                var promises = regs.map(function(r) { return r.unregister(); });
                return Promise.all(promises);
            }).then(function() {
                return caches.keys();
            }).then(function(names) {
                return Promise.all(names.map(function(n) { return caches.delete(n); }));
            }).then(function() {
                localStorage.setItem('sw_cache_version', EXPECTED);
                window.location.reload();
            });
        } else if (!stored) {
            localStorage.setItem('sw_cache_version', EXPECTED);
        }
    })();
    </script>

    <!-- PERF-009: Critical CSS - Inline above-the-fold styles for faster first paint -->
    <style id="critical-css">
        /* Critical CSS for initial render */
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        html{font-size:16px;-webkit-text-size-adjust:100%}
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#F8FAFC;color:#122753;line-height:1.5}
        #app{display:flex;min-height:100vh}
        .sidebar{width:260px;background:linear-gradient(180deg,#122753 0%,#1E3A75 100%);color:#fff;padding:24px 16px;display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100}
        .main-content{flex:1;margin-left:260px;padding:24px;background:#F8FAFC;min-height:100vh}
        .logo{padding:8px 0 24px;text-align:center}
        .logo-img{max-width:180px;height:auto}
        .nav-menu{display:flex;flex-direction:column;gap:4px}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;color:rgba(255,255,255,0.8);text-decoration:none;border-radius:8px;transition:all 0.2s}
        .nav-item.active,.nav-item:hover{background:rgba(255,255,255,0.1);color:#fff}
        .header{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;background:#fff;border-radius:12px;margin-bottom:24px;box-shadow:0 4px 20px rgba(0,0,0,0.05)}
        .page{display:none}.page.active{display:block}
        /* Skeleton loading state */
        .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:skeleton-loading 1.5s infinite}
        @keyframes skeleton-loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
    </style>

    <!-- Preload critical resources -->
    <link rel="preload" href="styles.css?v=5" as="style">
    <link rel="preload" href="app_v2.js?v=9" as="script">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <!-- Non-critical CSS - load async with fallback -->
    <link rel="stylesheet" href="styles.css?v=5" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="styles.css?v=5"></noscript>
    <link rel="stylesheet" href="mobile-responsive.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="mobile-responsive.css"></noscript>

    <!-- Font loading with display=swap for FOUT prevention -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/jpeg" href="browser_tab_icon.jpg">
    <link rel="manifest" href="manifest.json">

    <!-- PERF-010: Performance Monitoring - Core Web Vitals -->
    <script>
        // Core Web Vitals tracking
        window.webVitals = {
            CLS: 0, LCP: 0, FID: 0, FCP: 0, TTFB: 0,
            report: function(metric) {
                console.log('[WebVitals]', metric.name, ':', metric.value.toFixed(2), metric.rating || '');
                this[metric.name] = metric.value;
                // Send to analytics endpoint if available
                if (window.API_BASE) {
                    fetch(window.API_BASE + '/api/metrics/vitals', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: metric.name, value: metric.value, rating: metric.rating, url: location.pathname })
                    }).catch(() => {});
                }
            }
        };

        // Performance observer for LCP
        if ('PerformanceObserver' in window) {
            try {
                // Largest Contentful Paint
                new PerformanceObserver((list) => {
                    const entries = list.getEntries();
                    const lastEntry = entries[entries.length - 1];
                    webVitals.report({ name: 'LCP', value: lastEntry.startTime, rating: lastEntry.startTime < 2500 ? 'good' : lastEntry.startTime < 4000 ? 'needs-improvement' : 'poor' });
                }).observe({ type: 'largest-contentful-paint', buffered: true });

                // First Input Delay
                new PerformanceObserver((list) => {
                    list.getEntries().forEach(entry => {
                        webVitals.report({ name: 'FID', value: entry.processingStart - entry.startTime, rating: entry.processingStart - entry.startTime < 100 ? 'good' : 'poor' });
                    });
                }).observe({ type: 'first-input', buffered: true });

                // Cumulative Layout Shift
                let clsValue = 0;
                new PerformanceObserver((list) => {
                    list.getEntries().forEach(entry => {
                        if (!entry.hadRecentInput) clsValue += entry.value;
                    });
                    webVitals.report({ name: 'CLS', value: clsValue, rating: clsValue < 0.1 ? 'good' : clsValue < 0.25 ? 'needs-improvement' : 'poor' });
                }).observe({ type: 'layout-shift', buffered: true });

                // First Contentful Paint
                new PerformanceObserver((list) => {
                    list.getEntries().forEach(entry => {
                        if (entry.name === 'first-contentful-paint') {
                            webVitals.report({ name: 'FCP', value: entry.startTime, rating: entry.startTime < 1800 ? 'good' : 'poor' });
                        }
                    });
                }).observe({ type: 'paint', buffered: true });
            } catch (e) { console.log('[WebVitals] Observer error:', e); }

            // TTFB from navigation timing
            window.addEventListener('load', () => {
                const nav = performance.getEntriesByType('navigation')[0];
                if (nav) webVitals.report({ name: 'TTFB', value: nav.responseStart, rating: nav.responseStart < 800 ? 'good' : 'poor' });
            });
        }
    </script>
</head>

<body>
    <!-- WCAG 2.1 AA: Skip to main content link -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <!-- WCAG 2.1 AA: Screen reader announcement region -->
    <div id="sr-announcements" aria-live="polite" aria-atomic="true" class="sr-only"></div>

    <button class="mobile-menu-btn" onclick="toggleSidebar()" aria-label="Toggle navigation menu">
        <span aria-hidden="true">‚ò∞</span>
    </button>
    <div class="mobile-overlay" onclick="toggleSidebar()"></div>

    <div id="app">
        <!-- Sidebar -->
        <aside class="sidebar" id="mainSidebar" role="navigation" aria-label="Main navigation">
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebarCollapse()" title="Toggle Sidebar" aria-label="Collapse sidebar">
                <span class="toggle-chevron" aria-hidden="true">‚óÄ</span>
            </button>
            <div class="logo">
                <img src="certify_intel_logo.png" alt="Certify Intel" class="logo-img"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <h1 class="logo-fallback-hidden">Certify<span>Intel</span></h1>
                <span class="app-version">v10.0.0</span>
            </div>
            <nav class="nav-menu" aria-label="Page navigation">
                <a href="#" class="nav-item active" data-page="dashboard" aria-current="page">
                    <span class="icon" aria-hidden="true">üìä</span> Dashboard
                </a>
                <a href="#" class="nav-item" data-page="discovered">
                    <span class="icon" aria-hidden="true">üîÆ</span> Discovery Scout
                </a>
                <a href="#" class="nav-item" data-page="battlecards">
                    <span class="icon" aria-hidden="true">üÉè</span> Battlecards
                </a>
                <a href="#" class="nav-item" data-page="comparison">
                    <span class="icon" aria-hidden="true">‚öñÔ∏è</span> Comparisons
                </a>
                <a href="#" class="nav-item" data-page="newsfeed">
                    <span class="icon" aria-hidden="true">üì∞</span> Live News
                </a>
                <a href="#" class="nav-item" data-page="analytics">
                    <span class="icon" aria-hidden="true">üìà</span> Analytics
                </a>
                <a href="#" class="nav-item" data-page="salesmarketing">
                    <span class="icon" aria-hidden="true">üéØ</span> Sales & Marketing
                </a>
                <a href="#" class="nav-item" data-page="competitors">
                    <span class="icon" aria-hidden="true">üè¢</span> Records
                </a>
                <a href="#" class="nav-item" data-page="dataquality">
                    <span class="icon" aria-hidden="true">‚úÖ</span> Validation
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <span class="icon" aria-hidden="true">‚öôÔ∏è</span> Settings
                </a>
            </nav>
            <div class="sidebar-footer">
                <div id="system-status" class="status-box">
                    <div class="status-main">
                        <span class="status-dot"></span>
                        <span class="status-text">System Online</span>
                    </div>
                    <div class="status-sub">Auto-Pilot Active</div>
                </div>
                <a href="/api/export/excel" class="export-btn" target="_blank">
                    üì• Export Excel
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Header -->
            <header class="header" role="banner">
                <div class="search-bar" style="position: relative;">
                    <label for="globalSearch" class="sr-only">Search competitors</label>
                    <input type="text" id="globalSearch" placeholder="Search competitors..." autocomplete="off">
                    <div id="searchDropdown" class="search-dropdown"
                        style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid #334155; border-radius: 8px; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    </div>
                </div>
                <div class="header-actions">
                    <!-- Notification Bell -->
                    <div class="notification-container">
                        <button class="icon-btn" id="notificationBtn" onclick="toggleNotifications()" aria-label="Notifications" aria-haspopup="true" aria-expanded="false">
                            <span aria-hidden="true">üîî</span>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown" role="menu" aria-label="Notifications">
                            <div class="dropdown-header">
                                <span class="dropdown-title">Alerts</span>
                                <button class="alert-settings-btn" onclick="showPage('settings'); toggleNotifications();" title="Settings" aria-label="Alert settings">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="dropdown-content" id="notificationList">
                                <div class="notification-empty">
                                    <div class="empty-icon">üîî</div>
                                    <div class="empty-text">No new alerts</div>
                                </div>
                            </div>
                            <div class="dropdown-footer">
                                <a href="#" onclick="showPage('settings'); toggleNotifications(); return false;">Alert Settings</a>
                            </div>
                        </div>
                    </div>

                    <!-- AI Background Task Notifications -->
                    <div class="notification-container" style="margin-right: 8px;">
                        <button class="ai-notification-bell" id="aiNotifBell" onclick="toggleAINotificationPanel()" aria-label="AI background tasks" aria-haspopup="true" aria-expanded="false">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 6v6l4 2"></path>
                            </svg>
                            <span class="ai-notification-count" id="aiNotifCount">0</span>
                        </button>
                        <div class="ai-notification-panel" id="aiNotifPanel">
                            <div class="ai-notif-header">
                                <h4>AI Tasks</h4>
                                <button onclick="markAllAINotificationsRead()">Mark all read</button>
                            </div>
                            <div id="aiNotifList">
                                <div class="ai-notif-empty">No background AI tasks</div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="showThreatCriteriaModal()" style="margin-right: 8px;" aria-label="Configure threat criteria">
                        <span aria-hidden="true">‚öôÔ∏è</span> Threat Criteria
                    </button>
                    <button class="btn btn-primary" onclick="triggerScrapeAll()" aria-label="Refresh competitor data">
                        <span aria-hidden="true">üîÑ</span> Refresh Data
                    </button>
                    <div class="user-menu" id="userMenu">
                        <button class="user-avatar" id="userAvatar" onclick="toggleUserDropdown()" aria-label="User menu" aria-haspopup="true" aria-expanded="false">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </button>
                        <div class="user-dropdown" id="userDropdown">
                            <div class="dropdown-user-info">
                                <strong id="userName">User</strong>
                                <span id="userEmail">user@certifyhealth.com</span>
                                <span class="user-role" id="userRole">Analyst</span>
                            </div>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" id="inviteUserLink" onclick="showInviteUserModal()" style="display: none;">
                                üë§ Invite Team Member
                            </a>
                            <a href="#" class="dropdown-item" onclick="logout()">
                                üö™ Logout
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Dashboard Page -->
            <section id="dashboardPage" class="page active" aria-label="Dashboard">
                <div class="page-header">
                    <h2>Competitive Intelligence Dashboard</h2>
                    <p class="subtitle">Real-time competitor monitoring for Certify Health</p>
                    <div id="dashboardExportContainer" class="page-header-export"></div>
                </div>

                <!-- Last Data Refresh Indicator -->
                <div class="data-refresh-indicator" id="dataRefreshIndicator">
                    <div class="refresh-status">
                        <span class="refresh-icon">üîÑ</span>
                        <div class="refresh-info">
                            <span class="refresh-label">Last Data Refresh:</span>
                            <span class="refresh-time" id="lastRefreshTime">Not yet refreshed</span>
                        </div>
                    </div>
                    <p class="refresh-description">Data is automatically refreshed from all connected sources. Click "Refresh Data" to manually update.</p>
                </div>

                <!-- Data Refresh Progress (Inline) - Phase 1: Task 5.0.1-023 -->
                <div id="inlineRefreshProgress" class="inline-refresh-progress" style="display: none;" role="status" aria-live="polite">
                    <div class="refresh-progress-header">
                        <div class="refresh-progress-title">
                            <span class="refresh-icon spinning">üîÑ</span>
                            <span>Refreshing Competitor Data...</span>
                        </div>
                        <span id="inlineProgressPercent" class="progress-percent">0%</span>
                    </div>
                    <div class="inline-progress-bar-container">
                        <div id="inlineProgressBar" class="inline-progress-bar" style="width: 0%"></div>
                    </div>
                    <div class="refresh-progress-details">
                        <span id="inlineProgressText">Starting...</span>
                        <span id="inlineProgressCount">0 / 0 competitors</span>
                    </div>
                    <div id="inlineProgressLive" class="refresh-live-updates">
                        <!-- Live updates will appear here -->
                    </div>
                </div>

                <!-- AI-Generated Executive Summary -->
                <!-- AI-Generated Executive Summary -->
                <div id="aiSummaryCard" class="ai-summary-card">
                    <div class="ai-summary-header">
                        <div class="ai-summary-title-group">
                            <button id="aiSummaryToggle" class="ai-summary-toggle" onclick="toggleAISummary()" title="Expand/Collapse">
                                <span class="toggle-icon">‚ñº</span>
                            </button>
                            <div id="aiProviderLogo" class="ai-provider-logo" style="width: 32px; height: 32px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a2 2 0 0 1 0 4h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a2 2 0 0 1 0-4h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
                                    <circle cx="7.5" cy="14.5" r="1.5" fill="white"/>
                                    <circle cx="16.5" cy="14.5" r="1.5" fill="white"/>
                                </svg>
                            </div>
                            <h3 class="ai-summary-title">AI-Generated Executive Summary</h3>
                        </div>
                        <div class="ai-actions" style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                            <button id="editPromptBtn" class="btn btn-secondary btn-sm" title="Edit Instructions" onclick="openPromptEditor()">‚öôÔ∏è
                                Edit Prompt</button>
                            <button id="btnGenerateSummary" class="btn btn-primary btn-sm" onclick="startAISummary()">‚ú®
                                Generate Summary</button>
                            <button id="btnClearSummary" class="btn btn-secondary btn-sm" onclick="clearAISummary()">üóëÔ∏è
                                Clear</button>
                        </div>
                    </div>
                    <div id="aiSummaryContent" class="ai-summary-content" aria-live="polite">
                        <div class="ai-empty-state">
                            Ready to generate insights. Click "Generate Summary" to start.
                        </div>
                    </div>
                    <div id="aiSummaryMeta" class="ai-summary-meta"></div>

                    <!-- AI Chatbox -->
                    <div class="ai-chatbox">
                        <div class="ai-chatbox-header">
                            <span>üí¨ Ask follow-up questions about the competitive landscape</span>
                        </div>
                        <div id="aiChatMessages" class="ai-chat-messages"></div>
                        <div class="ai-chat-input-container">
                            <label for="aiChatInput" class="sr-only">Ask a question about the competitive landscape</label>
                            <input type="text" id="aiChatInput" class="ai-chat-input"
                                placeholder="Ask a question about competitors, pricing, threats..."
                                onkeypress="if(event.key==='Enter') sendAIChat()">
                            <button class="btn btn-primary ai-chat-send" onclick="sendAIChat()" aria-label="Send chat message">Send</button>
                        </div>
                    </div>
                </div>

                <!-- Prompt Editor Modal -->
                <div id="promptEditorModal" class="company-list-modal" style="display: none;">
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; border-radius: 12px; max-width: 900px; width: 95%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;"
                            onclick="event.stopPropagation()">
                            <div
                                style="background: #1B2B65; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; color: white !important;">Edit Qualifications</h3>
                                <button onclick="closePromptEditorModal()" aria-label="Close prompt editor"
                                    style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
                            </div>
                            <div style="padding: 20px; overflow-y: auto;">
                                <!-- System Prompt Selector (consolidated from header) -->
                                <div style="margin-bottom: 20px; padding: 15px; background: #eef2ff; border-radius: 8px; border: 1px solid #c7d2fe;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <label style="font-weight: 600; font-size: 14px; white-space: nowrap;">System Prompt:</label>
                                        <select id="dashboardPromptSelect" class="form-select" style="flex:1;font-size:13px;padding:8px 10px;border:1px solid #c7d2fe;border-radius:6px;"></select>
                                        <button class="btn btn-sm btn-secondary" onclick="openPromptViewModal('dashboardPromptSelect','dashboard')" title="View/Edit Selected" style="padding:6px 10px;font-size:12px;">View/Edit</button>
                                    </div>
                                </div>

                                <!-- Saved Prompts Section -->
                                <div class="saved-prompts-section" style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <label style="font-weight: 600; font-size: 14px;">My Saved Prompts</label>
                                        <button class="btn btn-sm btn-secondary" onclick="refreshSavedPrompts()" style="padding: 4px 10px; font-size: 12px;">Refresh</button>
                                    </div>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <select id="savedPromptsSelect" style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                                            <option value="">-- Select a saved prompt --</option>
                                        </select>
                                        <button class="btn btn-secondary btn-sm" onclick="loadSelectedPrompt()" style="padding: 8px 12px;">Load</button>
                                        <button class="btn btn-secondary btn-sm" onclick="deleteSelectedPrompt()" style="padding: 8px 12px; color: #dc3545;">Delete</button>
                                    </div>
                                </div>

                                <!-- Prompt Editor -->
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Executive
                                        Summary Prompt</label>
                                    <p style="font-size: 12px; color: #64748b; margin-bottom: 8px;">Instructions for the
                                        AI on how to format and focus the Weekly Executive Briefing.</p>
                                    <textarea id="summaryPromptInput"
                                        style="width: 100%; height: 250px; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: monospace; font-size: 14px; resize: vertical;"></textarea>
                                </div>

                                <!-- Save As New Section -->
                                <div class="save-new-section" style="margin-top: 16px; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 1px solid #bbf7d0;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">üíæ Save As New Prompt</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="text" id="newPromptName" placeholder="Enter prompt name (e.g., 'Weekly Brief v2')"
                                            style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                                        <button class="btn btn-primary btn-sm" onclick="saveAsNewPrompt()" style="padding: 8px 16px; white-space: nowrap;">Save As New</button>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div style="display: flex; justify-content: space-between; margin-top: 20px; padding-top: 16px; border-top: 1px solid #e2e8f0;">
                                    <button class="btn btn-secondary" onclick="loadDefaultPrompt()" style="padding: 10px 16px;">
                                        üîÑ Load Default
                                    </button>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn btn-secondary" onclick="closePromptEditorModal()">Cancel</button>
                                        <button class="btn btn-primary" onclick="saveSystemPrompt('dashboard_summary')">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Quick Action Cards (v5.4.0 Enhancement) - Moved to top -->
                <div class="quick-actions-section" style="margin-bottom: 24px;">
                    <h3 class="section-title">Quick Actions</h3>
                    <div class="quick-actions-grid">
                        <div class="quick-action-card" id="qa-schedule" onclick="quickActionSchedule(this)">
                            <div class="quick-action-icon">‚è∞</div>
                            <div class="quick-action-content">
                                <span class="quick-action-title">Schedule Refresh</span>
                                <span class="quick-action-desc">Configure auto-refresh timing</span>
                            </div>
                            <span class="quick-action-arrow">‚Üí</span>
                        </div>
                        <div class="quick-action-card" id="qa-discover" onclick="quickActionDiscover(this)">
                            <div class="quick-action-icon">üîç</div>
                            <div class="quick-action-content">
                                <span class="quick-action-title">Discover Competitors</span>
                                <span class="quick-action-desc">Find new competitors with AI</span>
                            </div>
                            <span class="quick-action-arrow">‚Üí</span>
                        </div>
                        <div class="quick-action-card" id="qa-report" onclick="quickActionReport(this)">
                            <div class="quick-action-icon">üìä</div>
                            <div class="quick-action-content">
                                <span class="quick-action-title">Export Report</span>
                                <span class="quick-action-desc">Download Excel competitor report</span>
                            </div>
                            <span class="quick-action-arrow">‚Üí</span>
                        </div>
                        <div class="quick-action-card" id="qa-compare" onclick="quickActionNavigate(this, 'comparison')">
                            <div class="quick-action-icon">‚öñÔ∏è</div>
                            <div class="quick-action-content">
                                <span class="quick-action-title">Compare Competitors</span>
                                <span class="quick-action-desc">Side-by-side analysis</span>
                            </div>
                            <span class="quick-action-arrow">‚Üí</span>
                        </div>
                        <div class="quick-action-card" id="qa-news" onclick="quickActionNavigate(this, 'newsfeed')">
                            <div class="quick-action-icon">üì∞</div>
                            <div class="quick-action-content">
                                <span class="quick-action-title">Latest News</span>
                                <span class="quick-action-desc">View competitive intelligence news</span>
                            </div>
                            <span class="quick-action-arrow">‚Üí</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card stat-card-clickable" onclick="showCompanyList('all')"
                        title="Click to see all competitors">
                        <div class="stat-icon blue">üè¢</div>
                        <div class="stat-content">
                            <span class="stat-value" id="totalCompetitors">0</span>
                            <span class="stat-label">Total Competitors</span>
                        </div>
                        <div class="stat-tooltip stat-tooltip-hidden" id="tooltip-all"></div>
                    </div>
                    <div class="stat-card stat-card-clickable" onclick="showCompanyList('High')"
                        title="Click to see High Threat competitors">
                        <div class="stat-icon red">üî¥</div>
                        <div class="stat-content">
                            <span class="stat-value" id="highThreat">0</span>
                            <span class="stat-label">High Threat</span>
                        </div>
                        <div class="stat-tooltip stat-tooltip-hidden" id="tooltip-high"></div>
                    </div>
                    <div class="stat-card stat-card-clickable" onclick="showCompanyList('Medium')"
                        title="Click to see Medium Threat competitors">
                        <div class="stat-icon yellow">üü°</div>
                        <div class="stat-content">
                            <span class="stat-value" id="mediumThreat">0</span>
                            <span class="stat-label">Medium Threat</span>
                        </div>
                        <div class="stat-tooltip stat-tooltip-hidden" id="tooltip-medium"></div>
                    </div>
                    <div class="stat-card stat-card-clickable" onclick="showCompanyList('Low')"
                        title="Click to see Low Threat competitors">
                        <div class="stat-icon green">üü¢</div>
                        <div class="stat-content">
                            <span class="stat-value" id="lowThreat">0</span>
                            <span class="stat-label">Low Threat</span>
                        </div>
                        <div class="stat-tooltip stat-tooltip-hidden" id="tooltip-low"></div>
                    </div>
                </div>

                <!-- Enhanced Dashboard Mini-Widgets -->
                <div class="dashboard-mini-widgets" id="dashboardMiniWidgets">
                    <div class="mini-widget">
                        <div class="mini-widget-icon" style="background: rgba(59, 130, 246, 0.12); color: #3b82f6;">&#128200;</div>
                        <div class="mini-widget-content">
                            <span class="mini-widget-value" id="miniActivityTrend">--</span>
                            <span class="mini-widget-label">News + Updates (30d)</span>
                        </div>
                        <div class="mini-widget-sparkline" id="miniActivitySparkline"></div>
                    </div>
                    <div class="mini-widget">
                        <div class="mini-widget-icon" style="background: rgba(16, 185, 129, 0.12); color: #10b981;">&#128337;</div>
                        <div class="mini-widget-content">
                            <span class="mini-widget-value" id="miniDataFreshness">--</span>
                            <span class="mini-widget-label">Data Freshness</span>
                        </div>
                    </div>
                    <div class="mini-widget">
                        <div class="mini-widget-icon" style="background: rgba(139, 92, 246, 0.12); color: #8b5cf6;">&#127942;</div>
                        <div class="mini-widget-content">
                            <span class="mini-widget-value" id="miniWinRate">--</span>
                            <span class="mini-widget-label">Win Rate</span>
                        </div>
                    </div>
                    <div class="mini-widget">
                        <div class="mini-widget-icon" style="background: rgba(245, 158, 11, 0.12); color: #f59e0b;">&#128101;</div>
                        <div class="mini-widget-content">
                            <span class="mini-widget-value" id="miniActiveUsers">--</span>
                            <span class="mini-widget-label">Active Users (7d)</span>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="charts-row">
                    <div class="chart-card">
                        <h3>Threat Distribution</h3>
                        <canvas id="threatChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <h3 style="margin:0;">Top Competitive Threats</h3>
                            <select id="threatCountSelect" class="threat-count-select" aria-label="Number of threats to display">
                                <option value="3">Top 3</option>
                                <option value="5" selected>Top 5</option>
                                <option value="10">Top 10</option>
                                <option value="20">Top 20</option>
                            </select>
                        </div>
                        <canvas id="topThreatsChart"></canvas>
                    </div>
                </div>

                <!-- Threat Level Trend Chart -->
                <div class="chart-card" style="margin-bottom: 24px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <h3 style="margin:0;">Threat Level Trends</h3>
                        <div class="date-range-picker" id="trendDateRangePicker">
                            <button class="range-btn" data-days="7">7d</button>
                            <button class="range-btn" data-days="30">30d</button>
                            <button class="range-btn active" data-days="90">90d</button>
                            <button class="range-btn" data-days="365">1y</button>
                        </div>
                    </div>
                    <div id="threatTrendChartContainer" style="position: relative; min-height: 250px;">
                        <canvas id="threatTrendChart"></canvas>
                    </div>
                </div>

                <!-- Top Threats Table -->
                <div class="table-card">
                    <div class="table-header">
                        <h3>Top Competitive Threats</h3>
                        <a href="#" class="view-all" onclick="showPage('competitors')">View All ‚Üí</a>
                    </div>
                    <table class="data-table" id="topThreatsTable">
                        <thead>
                            <tr>
                                <th>Competitor</th>
                                <th>Threat Level</th>
                                <th>Customers</th>
                                <th>Pricing</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="topThreatsBody">
                            <!-- Loaded dynamically -->
                        </tbody>
                    </table>
                </div>

                <!-- Recent Changes -->
                <div class="table-card">
                    <div class="table-header">
                        <h3>Recent Changes</h3>
                        <a href="#" class="view-all" onclick="showPage('changes')">View All ‚Üí</a>
                    </div>
                    <div id="recentChanges" class="changes-list">
                        <!-- Loaded dynamically -->
                    </div>
                </div>
            </section>

            <!-- Competitors Page -->
            <section id="competitorsPage" class="page" aria-label="Records">
                <div class="page-header">
                    <h2>Records</h2>
                    <div id="recordsExportContainer" class="page-header-export"></div>
                    <button class="btn btn-secondary btn-margin-right" onclick="triggerDiscovery()">üîÆ Discover
                        New</button>
                    <button class="btn btn-primary" onclick="showAddCompetitorModal()">+ Add Competitor</button>
                </div>

                <!-- Tab Bar -->
                <div class="activity-tab-bar">
                    <button class="activity-tab active" data-tab="competitorRecords" onclick="switchRecordsTab('competitorRecords')">Competitor Records</button>
                    <button class="activity-tab" data-tab="activityLog" onclick="switchRecordsTab('activityLog')">Activity Log</button>
                </div>

                <!-- Tab: Competitor Records (existing content) -->
                <div id="competitorRecordsTab" class="records-tab-content active">
                    <div class="filters-bar">
                        <select id="filterThreat" aria-label="Filter by threat level" title="Filter by threat level">
                            <option value="">All Threats</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                        <select id="filterStatus" aria-label="Filter by status" title="Filter by status">
                            <option value="">All Status</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                        <select id="sortCompetitors" aria-label="Sort competitors" title="Sort competitors">
                            <option value="">Sort by...</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="threat">Threat Level</option>
                            <option value="employees">Employees</option>
                        </select>
                        <div class="filters-bar-spacer"></div>
                        <div class="view-toggle" id="competitorViewToggle">
                            <button class="view-btn active" data-view="grid" onclick="setCompetitorView('grid')" aria-label="Grid view" title="Grid view">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg>
                            </button>
                            <button class="view-btn" data-view="list" onclick="setCompetitorView('list')" aria-label="List view" title="List view">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="2" width="14" height="2.5" rx="1"/><rect x="1" y="6.75" width="14" height="2.5" rx="1"/><rect x="1" y="11.5" width="14" height="2.5" rx="1"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="competitors-grid" id="competitorsGrid">
                        <!-- Loaded dynamically -->
                    </div>
                </div>

                <!-- Tab: Activity Log -->
                <div id="activityLogTab" class="records-tab-content" style="display:none;">
                    <!-- Summary Bar -->
                    <div class="activity-summary-bar" id="activitySummaryBar">
                        <div class="activity-stat-card">
                            <div class="activity-stat-icon" style="background: rgba(96,165,250,0.15); color: #60a5fa;">&#x1f4ca;</div>
                            <div class="activity-stat-info">
                                <span class="activity-stat-value" id="activityTotalActions">--</span>
                                <span class="activity-stat-label">Total Actions (7d)</span>
                            </div>
                        </div>
                        <div class="activity-stat-card">
                            <div class="activity-stat-icon" style="background: rgba(52,211,153,0.15); color: #34d399;">&#x1f465;</div>
                            <div class="activity-stat-info">
                                <span class="activity-stat-value" id="activityUniqueUsers">--</span>
                                <span class="activity-stat-label">Active Users</span>
                            </div>
                        </div>
                        <div class="activity-stat-card">
                            <div class="activity-stat-icon" style="background: rgba(251,191,36,0.15); color: #fbbf24;">&#x26a1;</div>
                            <div class="activity-stat-info">
                                <span class="activity-stat-value" id="activityTodayActions">--</span>
                                <span class="activity-stat-label">Today's Actions</span>
                            </div>
                        </div>
                        <div class="activity-stat-card">
                            <div class="activity-stat-icon" style="background: rgba(168,85,247,0.15); color: #a855f7;">&#x1f3af;</div>
                            <div class="activity-stat-info">
                                <span class="activity-stat-value" id="activityTopType">--</span>
                                <span class="activity-stat-label">Top Action Type</span>
                            </div>
                        </div>
                    </div>

                    <!-- Filters Row -->
                    <div class="activity-filters">
                        <select id="activityTypeFilter" aria-label="Filter by action type" title="Filter by action type">
                            <option value="">All Action Types</option>
                        </select>
                        <input type="text" id="activitySearchFilter" placeholder="Search by user or details..." aria-label="Search activity logs" />
                        <input type="date" id="activityDateFrom" aria-label="From date" title="From date" />
                        <input type="date" id="activityDateTo" aria-label="To date" title="To date" />
                        <button class="btn btn-primary btn-sm" onclick="applyActivityFilters()">Apply</button>
                        <button class="btn btn-secondary btn-sm" onclick="resetActivityFilters()">Reset</button>
                    </div>

                    <!-- Activity Timeline -->
                    <div class="activity-timeline" id="activityTimeline">
                        <div class="activity-loading" style="text-align:center; padding:40px; color: var(--text-secondary);">Loading activity logs...</div>
                    </div>
                    <div style="text-align:center; margin: 16px 0;">
                        <button class="btn btn-secondary" id="activityLoadMoreBtn" onclick="loadMoreActivityLogs()" style="display:none;">Load More</button>
                    </div>

                    <!-- Activity Trend Chart -->
                    <div class="glass-panel" style="margin-top: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">Activity Trend (30 Days)</h3>
                        <canvas id="activityTrendChart" height="250"></canvas>
                    </div>
                </div>
            </section>

            <!-- Competitor Discovery Page -->
            <section id="discoveredPage" class="page" aria-label="Discovery Scout">
                <div class="page-header">
                    <h2>Discovery Scout</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="showDiscoveryHistoryModal()">All Past Discoveries</button>
                    </div>
                </div>

                <!-- Info Box ‚Äî moved to top for first-time user context (Issue #3, #9) -->
                <div class="discovery-info" style="margin-bottom: 16px; padding: 16px; background: linear-gradient(135deg, #1e3a5f, #0f172a); border-radius: 8px; border: 1px solid #3b82f6;">
                    <details id="discoveryHowItWorks" open>
                        <summary style="font-size: 16px; font-weight: 700; color: #f1f5f9; cursor: pointer; list-style: none; display: flex; align-items: center; gap: 8px;">
                            <span id="discoveryInfoChevron" style="transition: transform 0.2s; display: inline-block;">&#9660;</span>
                            AI-Powered Discovery Engine
                        </summary>
                        <p style="margin: 8px 0 0 0; color: #94a3b8; font-weight: 500;">
                            4-stage pipeline: Google Search grounding, deep website analysis, AI qualification, and threat assessment.
                            Companies are ranked by match score based on your criteria below.
                        </p>
                    </details>
                </div>

                <!-- Schedule Panel (toggleable) -->
                <div id="discoverySchedulePanel" class="schedule-panel" style="display: none; padding: 16px; background: var(--bg-card); border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                        <div>
                            <h4 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 700;">Schedule Discovery Run</h4>
                            <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Schedule an automated discovery scan for later.</p>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <input type="datetime-local" id="scheduleRunTime" class="form-control" style="width: 220px;">
                            <button class="btn btn-primary" onclick="scheduleDiscoveryRun()">Schedule Run</button>
                            <button class="btn btn-secondary" onclick="toggleSchedulePanel()">Close</button>
                        </div>
                    </div>
                </div>

                <!-- Qualification Criteria Panel -->
                <div id="qualificationCriteriaPanel" class="qualification-panel"
                     style="padding: 20px; background: var(--bg-card); border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color);">

                    <!-- Collapsed summary (shown when criteria panel is collapsed) -->
                    <div id="criteriaSummaryBar" style="display: none; cursor: pointer;" onclick="toggleCriteriaPanel(true)">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 4px; font-weight: 700; font-size: 15px;">Qualification Criteria</h3>
                                <p id="criteriaSummaryText" style="margin: 0; font-size: 13px; color: var(--text-secondary);"></p>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="btn btn-secondary" onclick="event.stopPropagation(); toggleCriteriaPanel(true)" style="font-size: 13px;">Edit Criteria</button>
                                <button id="runDiscoveryBtnCollapsed" class="btn btn-primary discovery-start-btn" onclick="event.stopPropagation(); runDiscovery()">
                                    Start AI Discovery
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Expanded criteria (full form) -->
                    <div id="criteriaExpandedContent">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                            <h3 style="margin: 0; font-weight: 700;">Qualification Criteria</h3>
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <select id="discoveryMaxCandidates" class="form-control" style="width: 120px;">
                                    <option value="5">5 results</option>
                                    <option value="10" selected>10 results</option>
                                    <option value="25">25 results</option>
                                    <option value="50">50 results</option>
                                    <option value="100">100 results</option>
                                </select>
                                <button class="btn btn-secondary" onclick="toggleSchedulePanel()" title="Schedule for later" style="font-size: 12px;">Schedule</button>
                            </div>
                        </div>

                        <div class="criteria-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">

                            <!-- Column 1: Market & Industry -->
                            <div class="criteria-section" style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: var(--primary-color);">Target Market</h4>
                                <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="segment" value="hospital"> Hospitals & Health Systems
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="segment" value="ambulatory" checked> Ambulatory Care
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="segment" value="urgent_care"> Urgent Care
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="segment" value="behavioral"> Behavioral Health
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="segment" value="telehealth"> Telehealth
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="segment" value="dental_dso"> Dental / DSO
                                    </label>
                                </div>
                            </div>

                            <!-- Column 2: Product Capabilities -->
                            <div class="criteria-section" style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: var(--primary-color);">Required Capabilities</h4>
                                <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="capability" value="pxp" checked> Patient Experience Platform
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="capability" value="pms"> Practice Management
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="capability" value="rcm"> Revenue Cycle Management
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="capability" value="ehr"> EHR/EMR
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="capability" value="telehealth"> Telehealth
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                        <input type="checkbox" name="capability" value="payments"> Patient Payments
                                    </label>
                                </div>
                            </div>

                            <!-- Column 3: Company Filters -->
                            <div class="criteria-section" style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 700; color: var(--primary-color);">Company Filters</h4>

                                <label class="form-label" style="font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block;">Employee Count</label>
                                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                    <input type="number" id="minEmployees" class="form-control" placeholder="Min" style="width: 70px; font-size: 12px;">
                                    <span style="line-height: 32px; font-size: 12px;">to</span>
                                    <input type="number" id="maxEmployees" class="form-control" placeholder="Max" style="width: 70px; font-size: 12px;">
                                </div>

                                <label class="form-label" style="font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block;">Geography</label>
                                <div class="checkbox-group" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px;">
                                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
                                        <input type="checkbox" name="geography" value="us" checked> United States
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;">
                                        <input type="checkbox" name="geography" value="canada"> Canada
                                    </label>
                                </div>

                                <label class="form-label" style="font-size: 12px; font-weight: 600; margin-bottom: 4px; display: block;">Funding Stage</label>
                                <div class="checkbox-group" style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; cursor: pointer;">
                                        <input type="checkbox" name="funding" value="series_a"> Series A+
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 4px; font-size: 11px; cursor: pointer;">
                                        <input type="checkbox" name="funding" value="profitable"> Profitable
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Exclusions Row -->
                        <div style="margin-top: 16px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 700; color: var(--warning-color);">Exclude Companies That Are</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                                    <input type="checkbox" name="exclude" value="consulting" checked> Consulting
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                                    <input type="checkbox" name="exclude" value="pharma" checked> Pharma
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                                    <input type="checkbox" name="exclude" value="devices" checked> Devices
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;">
                                    <input type="checkbox" name="exclude" value="staffing"> Staffing
                                </label>
                            </div>
                        </div>

                        <!-- Advanced Options (collapsible) ‚Äî Issue #4, #6 -->
                        <details id="discoveryAdvancedOptions" style="margin-top: 16px;">
                            <summary style="font-size: 13px; font-weight: 700; color: var(--primary-color); cursor: pointer; padding: 8px 0;">
                                Advanced Options
                            </summary>
                            <div style="margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label class="form-label" style="font-size: 13px; font-weight: 700; margin-bottom: 8px; display: block;">Additional Keywords</label>
                                    <input type="text" id="customIncludeKeywords" class="form-control"
                                           placeholder="patient portal, digital intake..." style="font-size: 12px;">
                                </div>
                                <div>
                                    <label class="form-label" style="font-size: 13px; font-weight: 700; margin-bottom: 8px; display: block;">Exclude Keywords</label>
                                    <input type="text" id="customExcludeKeywords" class="form-control"
                                           placeholder="job board, careers..." style="font-size: 12px;">
                                </div>
                            </div>

                            <!-- Custom Instructions -->
                            <div style="margin-top: 12px; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px;">
                                <label class="form-label" style="font-size: 13px; font-weight: 700; margin-bottom: 8px; display: block;">Custom Instructions (Optional)</label>
                                <textarea id="discoveryCustomInstructions" class="form-control"
                                          placeholder="Add any custom instructions for the AI discovery pipeline, e.g. 'Focus on companies that recently raised funding' or 'Prioritize companies with FHIR integrations'..."
                                          style="width: 100%; height: 72px; font-size: 12px; resize: vertical; line-height: 1.4;"></textarea>
                                <p style="margin: 4px 0 0; font-size: 11px; color: var(--text-muted);">These instructions are appended to the structured criteria above when running discovery.</p>
                            </div>

                            <!-- AI Prompt Selector ‚Äî moved from top-level (Issue #6) -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 13px; font-weight: 700; white-space: nowrap;">AI Prompt:</label>
                                <select id="discoveryPromptSelect" class="form-select" style="flex:1; font-size:13px; padding:8px 10px; border:1px solid #c7d2fe; border-radius:6px;"></select>
                                <button class="btn btn-sm btn-secondary" onclick="openPromptViewModal('discoveryPromptSelect','discovery')" title="View/Edit Selected Prompt" style="padding:6px 10px; font-size:12px;">View/Edit</button>
                            </div>

                            <!-- Saved Profiles ‚Äî moved from header (Issue #5) -->
                            <div style="display: flex; align-items: center; gap: 8px; margin-top: 12px; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px;">
                                <label style="font-size: 13px; font-weight: 700; white-space: nowrap;">Saved Profiles:</label>
                                <select id="profileSelector" class="form-control" onchange="loadProfile(this.value)" style="flex: 1;">
                                    <option value="">-- Saved Criteria --</option>
                                </select>
                                <button class="btn btn-secondary" onclick="saveCurrentProfile()" title="Save current criteria as a profile" style="font-size: 12px;">Save</button>
                                <button class="btn btn-secondary" onclick="deleteCurrentProfile()" title="Delete selected profile" style="padding: 8px 10px; font-size: 12px;">Delete</button>
                            </div>
                        </details>

                        <!-- Primary Action Button ‚Äî full width, visually dominant (Issue #5) -->
                        <div style="margin-top: 20px;">
                            <button id="runDiscoveryBtn" class="btn btn-primary discovery-start-btn" onclick="runDiscovery()" style="width: 100%; padding: 14px 24px; font-size: 16px; font-weight: 700; white-space: nowrap;">
                                Start AI Discovery
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Discovery Progress Bar -->
                <div id="discoveryProgressContainer" style="display: none; margin-bottom: 20px; padding: 20px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border-color);">
                    <h4 style="margin: 0 0 12px; font-weight: 700;">AI Discovery Progress</h4>
                    <div id="discoveryProgressBar" style="height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
                        <div id="discoveryProgressFill" style="height: 100%; width: 0%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 4px; transition: width 0.5s ease;"></div>
                    </div>
                    <div id="discoveryProgressText" style="font-size: 13px; color: var(--text-secondary);"></div>
                    <div id="discoveryStageIndicators" style="display: flex; gap: 16px; margin-top: 12px;">
                        <span data-stage="search" class="stage-indicator" style="font-size: 13px; color: var(--text-muted);">Search</span>
                        <span data-stage="scrape" class="stage-indicator" style="font-size: 13px; color: var(--text-muted);">Scrape</span>
                        <span data-stage="qualify" class="stage-indicator" style="font-size: 13px; color: var(--text-muted);">Qualify</span>
                        <span data-stage="analyze" class="stage-indicator" style="font-size: 13px; color: var(--text-muted);">Analyze</span>
                    </div>
                </div>

                <!-- AI Discovery Summary -->
                <div id="discoverySummaryContainer" style="display: none; margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #1e3a5f, #0f172a); border-radius: 12px; border: 1px solid #3b82f6;">
                    <h4 style="margin: 0 0 12px; font-weight: 700; color: #f1f5f9;">AI Discovery Summary</h4>
                    <div id="discoverySummaryContent" style="color: #cbd5e1; font-size: 14px; line-height: 1.7;"></div>
                </div>

                <!-- Discovery Results Panel (unified ‚Äî no duplicate grid) -->
                <div id="discoveryResults" style="display: none; margin-bottom: 20px;">
                    <!-- Results Header with Sort -->
                    <div id="discoveryResultsHeader" style="display: none; margin-bottom: 16px; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span id="discoveryResultCount" style="font-weight: 700; font-size: 14px;"></span>
                                <button class="btn btn-sm btn-secondary" onclick="selectAllDiscoveries()" style="font-size: 12px; padding: 4px 10px;">
                                    Select All
                                </button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary);">Sort by:</label>
                                <select id="discoverySortSelect" class="form-control" onchange="sortDiscoveryResults(this.value)" style="width: 160px; font-size: 12px;">
                                    <option value="score_desc">Match Score (High)</option>
                                    <option value="score_asc">Match Score (Low)</option>
                                    <option value="threat_desc">Threat Level (High)</option>
                                    <option value="threat_asc">Threat Level (Low)</option>
                                    <option value="name_asc">Name (A-Z)</option>
                                    <option value="name_desc">Name (Z-A)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="discoveryResultsList" class="discovery-results-list">
                        <!-- Results will be populated here -->
                    </div>
                    <div id="discoveryActions" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="addSelectedDiscoveries()">
                            Add Selected to Competitors
                        </button>
                        <button class="btn btn-secondary" onclick="sendSelectedToBattlecard()" style="background: #7c3aed; color: white; border-color: #7c3aed;">
                            Generate Battlecards
                        </button>
                        <button class="btn btn-secondary" onclick="sendSelectedToComparison()" style="background: #0891b2; color: white; border-color: #0891b2;">
                            Compare Selected
                        </button>
                    </div>

                    <!-- Discovery Chat Widget (Issue #10) -->
                    <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                        <h4 style="margin: 0 0 8px; font-size: 14px; font-weight: 700; color: var(--text-secondary);">Have questions about these results?</h4>
                        <div id="discoveryChatContainer"></div>
                    </div>
                </div>

                <!-- Empty state (shown when no results exist) -->
                <div id="discoveryEmptyState" style="text-align: center; padding: 40px 20px; background: var(--bg-secondary, #f8fafc); border-radius: 12px; border: 1px solid var(--border-color, #e2e8f0);">
                    <p style="font-size: 48px; margin-bottom: 16px;">&#x1F50D;</p>
                    <h4 style="color: var(--text-primary, #1e293b); font-weight: 700; margin-bottom: 10px;">No Discovered Competitors Yet</h4>
                    <p id="discoveryEmptyDescription" style="color: var(--text-secondary, #475569); font-weight: 500; max-width: 500px; margin: 0 auto;">
                        Configure your criteria above and click <strong>Start AI Discovery</strong> to find competitors matching your search parameters.
                    </p>
                </div>
            </section>


            <!-- Discovery History Modal -->
            <div id="discoveryHistoryModal" class="company-list-modal" style="display: none;">
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;"
                    onclick="closeDiscoveryHistoryModal()">
                    <div style="background: white; border-radius: 12px; max-width: 1000px; width: 95%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;"
                        onclick="event.stopPropagation()">
                        <div style="background: #1B2B65; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; color: white !important;">All Past Discoveries</h3>
                            <button onclick="closeDiscoveryHistoryModal()"
                                style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div style="padding: 20px; overflow-y: auto; flex: 1;">
                            <div id="discoveryHistoryContent" style="min-height: 200px;">
                                <div style="text-align: center; padding: 40px; color: #64748b;">
                                    <div class="spinner"></div>
                                    <p>Loading discovery history...</p>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 16px 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="closeDiscoveryHistoryModal()">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparison Page -->
            <section id="comparisonPage" class="page" aria-label="Comparisons">
                <div class="page-header">
                    <h2>Comparisons</h2>
                </div>

                <!-- Comparison Type Tabs -->
                <div class="comparison-tabs">
                    <button class="comparison-tab active" onclick="switchComparisonTab('general')" data-tab="general">
                        üìä General Comparison
                    </button>
                    <button class="comparison-tab" onclick="switchComparisonTab('products')" data-tab="products">
                        üì¶ Product Matrix
                    </button>
                    <button class="comparison-tab" onclick="switchComparisonTab('dimensions')" data-tab="dimensions">
                        üéØ Dimension Scores
                    </button>
                    <button class="comparison-tab" onclick="switchComparisonTab('trends')" data-tab="trends">
                        üìà Trend Analysis
                    </button>
                    <button class="comparison-tab" onclick="switchComparisonTab('export')" data-tab="export">
                        üì§ Export
                    </button>
                </div>

                <!-- General Comparison Tab -->
                <div id="comparisonTabGeneral" class="comparison-tab-content active">
                    <div class="comparison-selector">
                        <label>Select competitors to compare:</label>
                        <div id="comparisonChecklist"></div>
                        <button class="btn btn-primary" onclick="runComparison()">Compare Selected</button>
                    </div>
                    <div id="comparisonResults"></div>
                </div>

                <!-- Product Comparison Matrix Tab (v5.4.0) -->
                <div id="comparisonTabProducts" class="comparison-tab-content" style="display: none;">
                    <div class="product-comparison-header">
                        <h3>üì¶ Product Comparison Matrix</h3>
                        <p class="subtitle">Compare product offerings across competitors</p>
                    </div>
                    <div class="product-comparison-selector">
                        <label>Select competitors for product comparison:</label>
                        <div id="productComparisonChecklist" class="competitor-checklist-grid"></div>
                        <button class="btn btn-primary" onclick="runProductComparison()">Compare Products</button>
                    </div>
                    <div id="productComparisonResults"></div>
                </div>

                <!-- Dimension Scores Tab -->
                <div id="comparisonTabDimensions" class="comparison-tab-content" style="display: none;">
                    <div class="dimension-comparison-header">
                        <h3>üéØ Dimension Score Comparison</h3>
                        <p class="subtitle">Compare competitive evaluation dimensions</p>
                    </div>
                    <div class="dimension-comparison-selector">
                        <label>Select competitors for dimension comparison:</label>
                        <div id="dimensionComparisonChecklist" class="competitor-checklist-grid"></div>
                        <button class="btn btn-primary" onclick="runDimensionComparison()">Compare Dimensions</button>
                    </div>
                    <div id="dimensionComparisonResults">
                        <div id="dimensionRadarContainer" style="max-width: 600px; margin: 24px auto;"></div>
                    </div>
                </div>

                <!-- FEAT-002: Trend Analysis Tab -->
                <div id="comparisonTabTrends" class="comparison-tab-content" style="display: none;">
                    <div class="trend-comparison-header">
                        <h3>üìà Competitive Trend Analysis</h3>
                        <p class="subtitle">Track competitor changes over time</p>
                    </div>
                    <div class="trend-comparison-controls">
                        <div class="trend-selector">
                            <label>Select competitors:</label>
                            <div id="trendComparisonChecklist" class="competitor-checklist-grid"></div>
                        </div>
                        <div class="trend-options">
                            <label>Metric:</label>
                            <select id="trendMetric" onchange="updateTrendChart()">
                                <option value="threat_level">Threat Level</option>
                                <option value="changes">Change Activity</option>
                                <option value="news_mentions">News Mentions</option>
                                <option value="data_freshness">Data Freshness</option>
                            </select>
                            <label>Period:</label>
                            <select id="trendPeriod" onchange="updateTrendChart()">
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                            <button class="btn btn-primary" onclick="runTrendAnalysis()">Analyze Trends</button>
                        </div>
                    </div>
                    <div id="trendChartContainer" style="margin-top: 24px;">
                        <canvas id="trendComparisonChart" height="300"></canvas>
                    </div>
                    <div id="trendInsights" class="trend-insights" style="margin-top: 24px;"></div>
                </div>

                <!-- FEAT-002: Export Tab -->
                <div id="comparisonTabExport" class="comparison-tab-content" style="display: none;">
                    <div class="export-comparison-header">
                        <h3>üì§ Export Comparison Data</h3>
                        <p class="subtitle">Generate shareable reports and presentations</p>
                    </div>
                    <div class="export-options-grid">
                        <div class="export-option-card">
                            <div class="export-icon">üìä</div>
                            <h4>PowerPoint Deck</h4>
                            <p>Generate a presentation-ready competitive analysis deck</p>
                            <div class="export-card-options">
                                <label>
                                    <input type="checkbox" id="exportIncludeCharts" checked> Include charts
                                </label>
                                <label>
                                    <input type="checkbox" id="exportIncludeDimensions" checked> Dimension scores
                                </label>
                                <label>
                                    <input type="checkbox" id="exportIncludeNews"> Recent news
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="exportComparisonPPTX()">Generate PPTX</button>
                        </div>
                        <div class="export-option-card">
                            <div class="export-icon">üìÑ</div>
                            <h4>PDF Report</h4>
                            <p>Comprehensive comparison report in PDF format</p>
                            <div class="export-card-options">
                                <label>
                                    <input type="checkbox" id="pdfIncludeSummary" checked> Executive summary
                                </label>
                                <label>
                                    <input type="checkbox" id="pdfIncludeDetail" checked> Detailed comparison
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="exportComparisonPDF()">Generate PDF</button>
                        </div>
                        <div class="export-option-card">
                            <div class="export-icon">üìà</div>
                            <h4>Excel Workbook</h4>
                            <p>Raw data in Excel format for custom analysis</p>
                            <div class="export-card-options">
                                <label>
                                    <input type="checkbox" id="excelAllCompetitors"> All competitors
                                </label>
                                <label>
                                    <input type="checkbox" id="excelSelectedOnly" checked> Selected only
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="exportComparisonExcel()">Download Excel</button>
                        </div>
                        <div class="export-option-card">
                            <div class="export-icon">üîó</div>
                            <h4>Share Link</h4>
                            <p>Generate a shareable link to this comparison</p>
                            <div class="export-card-options">
                                <label>
                                    <input type="checkbox" id="shareExpires" checked> Expires in 7 days
                                </label>
                                <label>
                                    <input type="checkbox" id="shareReadOnly" checked> Read-only access
                                </label>
                            </div>
                            <button class="btn btn-secondary" onclick="generateShareLink()">Copy Link</button>
                        </div>
                    </div>
                    <div id="exportPreview" class="export-preview" style="margin-top: 24px; display: none;">
                        <h4>Selected Competitors for Export:</h4>
                        <div id="exportPreviewList"></div>
                    </div>
                </div>
            </section>

            <!-- Changes Page -->
            <section id="changesPage" class="page" aria-label="Changes">
                <div class="page-header">
                    <h2>Change Log</h2>
                </div>
                <div class="filters-bar">
                    <select id="filterCompany" onchange="loadChanges()" aria-label="Filter by company"
                        title="Filter by company">
                        <option value="">All Companies</option>
                    </select>
                    <select id="filterSeverity" aria-label="Filter by severity" title="Filter by severity">
                        <option value="">All Severity</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                    <select id="filterDays" aria-label="Filter by time period" title="Filter by time period">
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 90 days</option>
                    </select>
                </div>
                <div id="changesList" class="changes-list-full">
                    <!-- Loaded dynamically -->
                </div>
            </section>

            <!-- News Feed Page (v5.0.3 - Phase 1) -->
            <section id="newsfeedPage" class="page" aria-label="Live News">
                <div class="page-header">
                    <h2>üì∞ Live News</h2>
                    <p class="subtitle">Aggregated news and intelligence from multiple sources</p>
                    <div id="newsExportContainer" class="page-header-export"></div>
                </div>

                <!-- NF-003: Advanced Filters Bar with Keyword Search -->
                <div class="news-feed-filters">
                    <!-- Keyword Search -->
                    <div class="filter-group keyword-search">
                        <label for="newsKeywordFilter">Keyword Search</label>
                        <div class="keyword-input-wrapper">
                            <input type="text" id="newsKeywordFilter" placeholder="Search headlines..."
                                   onkeypress="if(event.key==='Enter') loadNewsFeed()">
                            <button class="keyword-search-btn" onclick="loadNewsFeed()">üîç</button>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label for="newsCompetitorFilter">Competitor</label>
                        <select id="newsCompetitorFilter" onchange="loadNewsFeed()">
                            <option value="">All Competitors</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="newsDateFrom">From Date</label>
                        <input type="date" id="newsDateFrom" onchange="loadNewsFeed()">
                    </div>

                    <div class="filter-group">
                        <label for="newsDateTo">To Date</label>
                        <input type="date" id="newsDateTo" onchange="loadNewsFeed()">
                    </div>

                    <div class="filter-group">
                        <label for="newsSentimentFilter">Sentiment</label>
                        <select id="newsSentimentFilter" onchange="loadNewsFeed()">
                            <option value="">All Sentiment</option>
                            <option value="positive">üü¢ Positive</option>
                            <option value="neutral">üü° Neutral</option>
                            <option value="negative">üî¥ Negative</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="newsSourceFilter">Source</label>
                        <select id="newsSourceFilter" onchange="loadNewsFeed()">
                            <option value="">All Sources</option>
                            <option value="google_news">Google News RSS</option>
                            <option value="sec_edgar">SEC EDGAR</option>
                            <option value="uspto">USPTO Patents</option>
                            <option value="newsapi">NewsAPI</option>
                            <option value="gnews">GNews</option>
                            <option value="mediastack">MediaStack</option>
                            <option value="newsdata">NewsData.io</option>
                            <option value="rss_feed">Custom RSS</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="newsEventFilter">Event Type</label>
                        <select id="newsEventFilter" onchange="loadNewsFeed()">
                            <option value="">All Events</option>
                            <option value="funding">üí∞ Funding</option>
                            <option value="acquisition">ü§ù Acquisition</option>
                            <option value="product_launch">üöÄ Product Launch</option>
                            <option value="partnership">üîó Partnership</option>
                            <option value="leadership">üëî Leadership</option>
                            <option value="financial">üìä Financial</option>
                            <option value="legal">‚öñÔ∏è Legal</option>
                            <option value="patent">üìã Patent</option>
                            <option value="general">üìÑ General</option>
                        </select>
                    </div>

                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="loadNewsFeed()">
                            üîç Search
                        </button>
                        <button class="btn btn-secondary" onclick="resetNewsFeedFilters()">
                            ‚Ü∫ Reset
                        </button>
                    </div>
                </div>

                <!-- NF-004: AI News Summarization Controls -->
                <div class="news-ai-controls">
                    <div class="ai-summary-actions">
                        <div class="prompt-selector-inline" style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                            <label style="font-size:12px;color:#94a3b8;white-space:nowrap;">AI Prompt:</label>
                            <select id="newsPromptSelect" class="form-select" style="max-width:280px;font-size:12px;padding:4px 8px;"></select>
                            <button class="btn btn-sm btn-secondary" onclick="openPromptViewModal('newsPromptSelect','news')" title="View/Edit Prompt" style="padding:4px 8px;font-size:11px;">‚úèÔ∏è</button>
                        </div>
                        <button class="btn btn-ai" id="summarizeNewsBtn" onclick="summarizeAllNews()" disabled
                            title="Run AI Fetch News first to enable this button">
                            Summarize News Articles
                        </button>
                    </div>
                    <div class="live-aggregation-status" id="liveAggregationStatus">
                        <span class="status-indicator live"></span>
                        <span>Live Aggregation: <strong id="sourceCount">0</strong> sources active</span>
                        <button class="btn btn-primary btn-sm" onclick="fetchAINews()" id="aiNewsFetchBtn">ü§ñ AI Fetch News</button>
                        <button class="btn btn-sm" onclick="refreshAllNewsSources()">üîÑ Refresh All</button>
                        <button class="btn btn-sm" onclick="toggleSubscriptionsPanel()" id="manageSubscriptionsBtn" title="Manage alert subscriptions">üîî Alerts</button>
                    </div>
                </div>

                <!-- NF-004: AI Summary Modal -->
                <div id="newsSummaryModal" class="modal" style="display: none;">
                    <div class="modal-content news-summary-modal">
                        <div class="modal-header">
                            <h3>ü§ñ AI News Summary</h3>
                            <button class="modal-close" onclick="closeNewsSummaryModal()">&times;</button>
                        </div>
                        <div class="modal-body" id="newsSummaryContent">
                            <div class="summary-loading">
                                <div class="loading-spinner"></div>
                                <p>Analyzing news articles...</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeNewsSummaryModal()">Close</button>
                            <button class="btn btn-primary" onclick="exportNewsSummary()">üìÑ Export PDF</button>
                            <button class="btn btn-secondary" onclick="copyNewsSummary()">üìã Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Alert Subscriptions Panel -->
                <div class="news-subscriptions-panel glass-panel" id="newsSubscriptionsPanel" style="display: none; margin-bottom: 20px;">
                    <div class="subscriptions-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h3 style="margin:0;font-size:16px;color:var(--text-primary);">Alert Subscriptions</h3>
                        <div style="display:flex;gap:8px;align-items:center;">
                            <span id="subscriptionCount" style="font-size:12px;color:var(--text-secondary);">0 active</span>
                            <button class="btn btn-primary btn-sm" onclick="showAddSubscriptionModal()">+ Subscribe</button>
                            <button class="btn btn-secondary btn-sm" onclick="toggleSubscriptionsPanel()" title="Close">X</button>
                        </div>
                    </div>
                    <div id="subscriptionsList" style="max-height:320px;overflow-y:auto;">
                        <div style="text-align:center;padding:24px;color:var(--text-secondary);">Loading subscriptions...</div>
                    </div>
                </div>

                <!-- News Stats Summary -->
                <div class="news-feed-stats" id="newsFeedStats">
                    <div class="news-stat-card">
                        <span class="stat-value" id="totalNewsCount">0</span>
                        <span class="stat-label">Total Articles</span>
                    </div>
                    <div class="news-stat-card positive">
                        <span class="stat-value" id="positiveNewsCount">0</span>
                        <span class="stat-label">Positive</span>
                    </div>
                    <div class="news-stat-card neutral">
                        <span class="stat-value" id="neutralNewsCount">0</span>
                        <span class="stat-label">Neutral</span>
                    </div>
                    <div class="news-stat-card negative">
                        <span class="stat-value" id="negativeNewsCount">0</span>
                        <span class="stat-label">Negative</span>
                    </div>
                </div>

                <!-- Sentiment Trend Chart -->
                <div id="sentimentChartContainer" class="sentiment-chart-section" style="display: none;">
                    <canvas id="sentimentTrendCanvas" height="200"></canvas>
                </div>

                <!-- News Feed Loading Indicator -->
                <div id="newsFeedLoading" class="news-feed-loading" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Loading news articles...</span>
                </div>

                <!-- News Feed Table -->
                <div class="news-feed-container">
                    <table class="news-feed-table" id="newsFeedTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Competitor</th>
                                <th>Headline</th>
                                <th>Source</th>
                                <th>Source Link</th>
                                <th>Sentiment</th>
                                <th>Event Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="newsFeedTableBody">
                            <!-- Loaded dynamically -->
                            <tr class="news-empty-state">
                                <td colspan="8">
                                    <div class="empty-state-content">
                                        <span class="empty-icon">üì∞</span>
                                        <p>No news articles found. Adjust your filters or refresh data.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div class="news-feed-pagination" id="newsFeedPagination">
                    <button class="pagination-btn" id="newsPrevBtn" onclick="loadNewsFeed(window.currentNewsPage - 1)" disabled>
                        ‚Üê Previous
                    </button>
                    <span class="pagination-info" id="newsPageInfo">Page 1 of 1</span>
                    <button class="pagination-btn" id="newsNextBtn" onclick="loadNewsFeed(window.currentNewsPage + 1)" disabled>
                        Next ‚Üí
                    </button>
                </div>
            </section>

            <!-- Analytics Page (AR-001, AR-002: LIVE Competitive Heatmap) -->
            <section id="analyticsPage" class="page" aria-label="Analytics">
                <div class="page-header">
                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                        <h2 style="margin-bottom:0;">üìä Analytics & Competitive Intelligence</h2>
                        <div id="analyticsExportContainer" class="page-header-export"></div>
                    </div>
                    <p class="subtitle">Real-time competitive landscape visualization</p>
                </div>

                <!-- AR-002: LIVE Competitive Heatmap - FLAGSHIP FEATURE -->
                <div class="heatmap-section">
                    <div class="heatmap-header">
                        <h3>üî• LIVE Competitive Heatmap</h3>
                        <div class="heatmap-controls">
                            <select id="heatmapSizeBy" class="form-select" onchange="updateHeatmap()">
                                <option value="employees">Size by Employees</option>
                                <option value="customers">Size by Customers</option>
                                <option value="products">Size by Products</option>
                            </select>
                            <select id="heatmapColorBy" class="form-select" onchange="updateHeatmap()">
                                <option value="threat_level">Color by Threat Level</option>
                                <option value="status">Color by Status</option>
                                <option value="sentiment">Color by News Sentiment</option>
                            </select>
                            <button class="btn btn-secondary" onclick="refreshHeatmapData()">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Heatmap Legend -->
                    <div class="heatmap-legend">
                        <div class="legend-section">
                            <span class="legend-title">Threat Level:</span>
                            <span class="legend-item"><span class="legend-dot threat-high"></span> High</span>
                            <span class="legend-item"><span class="legend-dot threat-medium"></span> Medium</span>
                            <span class="legend-item"><span class="legend-dot threat-low"></span> Low</span>
                        </div>
                        <div class="legend-section">
                            <span class="legend-title">Tile Size:</span>
                            <span class="legend-note">Larger tiles = Higher metric value</span>
                        </div>
                    </div>

                    <!-- Main Heatmap Grid -->
                    <div class="heatmap-container" id="heatmapContainer">
                        <div class="heatmap-loading">
                            <div class="loading-spinner"></div>
                            <span>Loading competitive landscape...</span>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="heatmap-stats" id="heatmapStats">
                        <div class="heatmap-stat">
                            <span class="stat-value" id="heatmapTotalCompetitors">-</span>
                            <span class="stat-label">Total Competitors</span>
                        </div>
                        <div class="heatmap-stat threat-high">
                            <span class="stat-value" id="heatmapHighThreat">-</span>
                            <span class="stat-label">High Threat</span>
                        </div>
                        <div class="heatmap-stat threat-medium">
                            <span class="stat-value" id="heatmapMediumThreat">-</span>
                            <span class="stat-label">Medium Threat</span>
                        </div>
                        <div class="heatmap-stat threat-low">
                            <span class="stat-value" id="heatmapLowThreat">-</span>
                            <span class="stat-label">Low Threat</span>
                        </div>
                    </div>
                </div>

                <!-- Market Position Quadrant Chart -->
                <div class="chart-card" style="margin: 24px 0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h3 style="margin:0;">Market Position Quadrant</h3>
                    </div>
                    <div id="marketQuadrantChartContainer" style="position:relative;min-height:400px;">
                        <canvas id="marketQuadrantChart"></canvas>
                    </div>
                </div>

                <!-- Win/Loss Deal Tracker -->
                <div class="chart-card" style="margin: 24px 0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h3 style="margin:0;">Win/Loss Deal Tracker</h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddDealModal()">+ Add Deal</button>
                    </div>
                    <div class="win-loss-summary" id="winLossSummary">
                        <div class="win-loss-stat">
                            <span class="win-loss-value" id="winLossTotal">--</span>
                            <span class="win-loss-label">Total Deals</span>
                        </div>
                        <div class="win-loss-stat win">
                            <span class="win-loss-value" id="winLossWon">--</span>
                            <span class="win-loss-label">Won</span>
                        </div>
                        <div class="win-loss-stat loss">
                            <span class="win-loss-value" id="winLossLost">--</span>
                            <span class="win-loss-label">Lost</span>
                        </div>
                        <div class="win-loss-stat">
                            <span class="win-loss-value" id="winLossRate">--%</span>
                            <span class="win-loss-label">Win Rate</span>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 2fr;gap:24px;margin-top:16px;">
                        <div style="position:relative;max-height:250px;">
                            <canvas id="winLossChart"></canvas>
                        </div>
                        <div id="winLossTableContainer" style="overflow-y:auto;max-height:300px;">
                            <table class="competitor-list-table" id="winLossTable">
                                <thead><tr>
                                    <th>Date</th>
                                    <th>Competitor</th>
                                    <th>Deal Size</th>
                                    <th>Outcome</th>
                                    <th>Notes</th>
                                </tr></thead>
                                <tbody id="winLossBody">
                                    <tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:24px;">No deals recorded yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Competitor Detail Modal (shown on tile click) -->
                <div id="competitorDetailModal" class="modal" style="display: none;">
                    <div class="modal-content competitor-detail-modal">
                        <div class="modal-header">
                            <h3 id="detailCompetitorName">Competitor Name</h3>
                            <button class="modal-close" onclick="closeCompetitorDetail()">&times;</button>
                        </div>
                        <div class="competitor-detail-tabs">
                            <button class="comp-detail-tab active" onclick="switchCompDetailTab('overview')" data-tab="overview">Overview</button>
                            <button class="comp-detail-tab" onclick="switchCompDetailTab('annotations')" data-tab="annotations">
                                Annotations <span id="compDetailAnnotationCount" class="tab-badge" style="display:none;">0</span>
                            </button>
                        </div>
                        <div class="modal-body" id="competitorDetailContent">
                            <!-- Populated dynamically -->
                        </div>
                        <div class="modal-body" id="competitorDetailAnnotations" style="display: none;">
                            <!-- Populated dynamically by loadCompDetailAnnotations -->
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeCompetitorDetail()">Close</button>
                            <button class="btn btn-primary" onclick="viewFullCompetitorProfile()">View Full Profile</button>
                        </div>
                    </div>
                </div>

                <!-- Additional Analytics Cards -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3>üìà Market Share Estimates</h3>
                        <div class="chart-controls">
                            <select id="marketShareMetric" onchange="updateMarketShareChart()">
                                <option value="customers">By Customer Count</option>
                                <option value="employees">By Employees</option>
                                <option value="products">By Products</option>
                            </select>
                        </div>
                        <canvas id="marketShareChart"></canvas>
                    </div>
                    <div class="analytics-card">
                        <h3>üìä Threat Distribution</h3>
                        <canvas id="threatDistributionChart"></canvas>
                    </div>
                    <div class="analytics-card full-width">
                        <h3>üéØ Feature Gap Analysis Matrix</h3>
                        <div class="feature-gap-controls">
                            <select id="featureGapCompetitor1" onchange="updateFeatureGapMatrix()">
                                <option value="">Select Competitor 1</option>
                            </select>
                            <select id="featureGapCompetitor2" onchange="updateFeatureGapMatrix()">
                                <option value="">Select Competitor 2</option>
                            </select>
                            <select id="featureGapCompetitor3" onchange="updateFeatureGapMatrix()">
                                <option value="">Select Competitor 3 (Optional)</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="updateFeatureGapMatrix()">
                                üîÑ Compare
                            </button>
                        </div>
                        <div id="featureGapContainer">
                            <p class="placeholder-text">Select competitors above to analyze feature gaps</p>
                        </div>
                    </div>
                </div>

                <!-- AR-005: Trend Analysis Dashboard -->
                <div class="trend-analysis-section">
                    <div class="section-header">
                        <h3>üìà Trend Analysis Dashboard</h3>
                        <div class="trend-controls">
                            <select id="trendTimeRange" onchange="updateTrendCharts()">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="365">Last Year</option>
                            </select>
                            <select id="trendCompetitor" onchange="updateTrendCharts()">
                                <option value="all">All Competitors</option>
                            </select>
                        </div>
                    </div>
                    <div class="trend-charts-grid">
                        <div class="trend-card">
                            <h4>üì∞ News Sentiment Over Time</h4>
                            <canvas id="sentimentTrendChart"></canvas>
                        </div>
                        <div class="trend-card">
                            <h4>üìä Competitive Activity</h4>
                            <canvas id="activityTrendChart"></canvas>
                        </div>
                        <div class="trend-card">
                            <h4>üéØ Threat Level Changes</h4>
                            <div id="threatChangesContainer">
                                <p class="placeholder-text">Loading threat level changes...</p>
                            </div>
                        </div>
                        <div class="trend-card">
                            <h4>üìà Growth Indicators</h4>
                            <canvas id="growthTrendChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- AR-010: Executive Briefing Generator -->
                <div class="executive-briefing-section">
                    <div class="section-header">
                        <h3>üìã Executive Briefing Generator</h3>
                        <div class="briefing-controls">
                            <select id="briefingPeriod">
                                <option value="daily">Daily Brief</option>
                                <option value="weekly" selected>Weekly Brief</option>
                                <option value="monthly">Monthly Brief</option>
                            </select>
                            <select id="briefingFocus">
                                <option value="all">All Competitors</option>
                                <option value="high_threat">High Threat Only</option>
                                <option value="top_10">Top 10 by Activity</option>
                            </select>
                            <button class="btn btn-primary" onclick="generateExecutiveBriefing()">
                                ü§ñ Generate AI Briefing
                            </button>
                            <button class="btn btn-secondary" onclick="exportBriefing('pdf')">
                                üìÑ Export PDF
                            </button>
                        </div>
                    </div>
                    <div id="executiveBriefingContainer" class="executive-briefing-content">
                        <div class="briefing-placeholder">
                            <span class="icon">üìä</span>
                            <h4>Generate Your Executive Briefing</h4>
                            <p>Click "Generate AI Briefing" to create a comprehensive competitive intelligence summary.</p>
                            <ul class="briefing-features">
                                <li>‚úÖ Key competitor movements and announcements</li>
                                <li>‚úÖ Threat level changes and market shifts</li>
                                <li>‚úÖ Strategic recommendations based on news</li>
                                <li>‚úÖ Action items for sales and product teams</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- AR-006: Dimension Radar Comparison -->
                <div class="dimension-radar-section">
                    <div class="section-header">
                        <h3>üìä Dimension Radar Comparison</h3>
                        <div class="radar-controls">
                            <select id="radarCompetitor1" class="form-select" onchange="updateDimensionRadar()">
                                <option value="">Select Competitor 1</option>
                            </select>
                            <select id="radarCompetitor2" class="form-select" onchange="updateDimensionRadar()">
                                <option value="">Select Competitor 2</option>
                            </select>
                            <select id="radarCompetitor3" class="form-select" onchange="updateDimensionRadar()">
                                <option value="">Select Competitor 3 (Optional)</option>
                            </select>
                            <select id="radarCompetitor4" class="form-select" onchange="updateDimensionRadar()">
                                <option value="">Select Competitor 4 (Optional)</option>
                            </select>
                            <label class="checkbox-label">
                                <input type="checkbox" id="radarIncludeCertify" onchange="updateDimensionRadar()" checked>
                                Include Certify Health
                            </label>
                        </div>
                    </div>
                    <div class="radar-comparison-container">
                        <div class="radar-chart-wrapper">
                            <canvas id="dimensionRadarCompareChart"></canvas>
                        </div>
                        <div class="radar-insights" id="radarInsights">
                            <h4>üìà Comparison Insights</h4>
                            <p class="placeholder-text">Select competitors to view dimension comparison insights.</p>
                        </div>
                    </div>
                </div>

                <!-- AR-007: Win/Loss Analytics -->
                <div class="winloss-analytics-section">
                    <div class="section-header">
                        <h3>üèÜ Win/Loss Analytics</h3>
                        <div class="winloss-controls">
                            <select id="winlossTimeRange" class="form-select" onchange="updateWinLossAnalytics()">
                                <option value="30">Last 30 Days</option>
                                <option value="90" selected>Last 90 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                            </select>
                            <select id="winlossCompetitor" class="form-select" onchange="updateWinLossAnalytics()">
                                <option value="all">All Competitors</option>
                            </select>
                            <button class="btn btn-secondary" onclick="showAddWinLossModal()">
                                ‚ûï Log Win/Loss
                            </button>
                        </div>
                    </div>

                    <!-- KPI Cards Row -->
                    <div class="winloss-kpi-row">
                        <div class="winloss-kpi-card">
                            <span class="winloss-kpi-value" id="wlTotalDeals">0</span>
                            <span class="winloss-kpi-label">Total Deals</span>
                        </div>
                        <div class="winloss-kpi-card">
                            <span class="winloss-kpi-value winloss-kpi-winrate" id="wlWinRate">0%</span>
                            <span class="winloss-kpi-label">Win Rate</span>
                        </div>
                        <div class="winloss-kpi-card">
                            <span class="winloss-kpi-value winloss-kpi-won" id="wlValueWon">$0</span>
                            <span class="winloss-kpi-label">Value Won</span>
                        </div>
                        <div class="winloss-kpi-card">
                            <span class="winloss-kpi-value winloss-kpi-lost" id="wlValueLost">$0</span>
                            <span class="winloss-kpi-label">Value Lost</span>
                        </div>
                    </div>

                    <!-- Charts Grid -->
                    <div class="winloss-grid">
                        <div class="winloss-card winloss-card-wide">
                            <h4>Monthly Win/Loss Trend</h4>
                            <canvas id="winLossMonthlyTrendChart"></canvas>
                        </div>
                        <div class="winloss-card">
                            <h4>Win Rate by Competitor</h4>
                            <canvas id="winRateByCompetitorChart"></canvas>
                        </div>
                        <div class="winloss-card">
                            <h4>Win/Loss Reasons</h4>
                            <canvas id="winLossReasonsChart"></canvas>
                        </div>
                        <div class="winloss-card">
                            <h4>Win Rate Trend</h4>
                            <canvas id="winRateTrendChart"></canvas>
                        </div>
                        <div class="winloss-card">
                            <h4>Dimension Correlation</h4>
                            <div id="dimensionCorrelation">
                                <p class="placeholder-text">Record deals with dimensions to see correlation</p>
                            </div>
                        </div>
                    </div>

                    <!-- Most Competitive Competitors -->
                    <div class="winloss-table-container">
                        <h4>Most Competitive Rivals</h4>
                        <table class="winloss-table" id="mostCompetitiveTable">
                            <thead>
                                <tr>
                                    <th class="sortable-th" data-sort="name" onclick="sortMostCompetitiveTable('name')">Competitor</th>
                                    <th class="sortable-th" data-sort="total" onclick="sortMostCompetitiveTable('total')">Deals</th>
                                    <th class="sortable-th" data-sort="wins" onclick="sortMostCompetitiveTable('wins')">Wins</th>
                                    <th class="sortable-th" data-sort="losses" onclick="sortMostCompetitiveTable('losses')">Losses</th>
                                    <th class="sortable-th" data-sort="win_rate" onclick="sortMostCompetitiveTable('win_rate')">Win Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="5" class="placeholder-text">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Deal Log -->
                    <div class="winloss-table-container">
                        <h4>Deal Log</h4>
                        <table class="winloss-table" id="winLossDealsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Competitor</th>
                                    <th>Outcome</th>
                                    <th>Deal Value</th>
                                    <th>Reason</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="placeholder-text">Loading deals...</td></tr>
                            </tbody>
                        </table>
                        <div id="winLossShowMore" style="display:none;text-align:center;margin-top:12px;">
                            <button class="btn btn-secondary btn-sm" onclick="showMoreDeals()">Show More Deals</button>
                        </div>
                    </div>
                </div>

                <!-- AR-008: Data Freshness Dashboard -->
                <div class="data-freshness-section">
                    <div class="section-header">
                        <h3>‚è∞ Data Freshness Dashboard</h3>
                        <div class="freshness-controls">
                            <select id="freshnessSort" class="form-select" onchange="updateFreshnessDashboard()">
                                <option value="stalest">Most Stale First</option>
                                <option value="freshest">Most Fresh First</option>
                                <option value="name">By Name</option>
                            </select>
                            <button class="btn btn-primary" onclick="triggerBulkRefresh()">
                                üîÑ Refresh Stale Data
                            </button>
                        </div>
                    </div>
                    <div class="freshness-summary" id="freshnessSummary">
                        <div class="freshness-stat fresh">
                            <span class="stat-value" id="freshDataCount">0</span>
                            <span class="stat-label">Fresh (&lt; 24h)</span>
                        </div>
                        <div class="freshness-stat warning">
                            <span class="stat-value" id="warningDataCount">0</span>
                            <span class="stat-label">Warning (1-7 days)</span>
                        </div>
                        <div class="freshness-stat stale">
                            <span class="stat-value" id="staleDataCount">0</span>
                            <span class="stat-label">Stale (&gt; 7 days)</span>
                        </div>
                        <div class="freshness-stat">
                            <span class="stat-value" id="avgDataAge">0</span>
                            <span class="stat-label">Avg Age (days)</span>
                        </div>
                    </div>
                    <div class="freshness-grid" id="freshnessGrid">
                        <p class="placeholder-text">Loading data freshness...</p>
                    </div>
                </div>

                <!-- AR-009: Export Center -->
                <div class="export-center-section">
                    <div class="section-header">
                        <h3>üì• Export Center</h3>
                    </div>
                    <div class="export-center-grid">
                        <div class="export-card">
                            <div class="export-icon">üìä</div>
                            <h4>Charts & Visualizations</h4>
                            <p>Export all analytics charts as PNG images</p>
                            <div class="export-options">
                                <button class="btn btn-secondary btn-sm" onclick="exportAllCharts('png')">üì∑ Export PNG</button>
                            </div>
                        </div>
                        <div class="export-card">
                            <div class="export-icon">üìë</div>
                            <h4>Competitor Data</h4>
                            <p>Export all competitor data as Excel spreadsheet</p>
                            <div class="export-options">
                                <button class="btn btn-secondary btn-sm" onclick="exportCompetitorData('excel')">üìó Export Excel</button>
                            </div>
                        </div>
                        <div class="export-card">
                            <div class="export-icon">üìã</div>
                            <h4>Full Report Package</h4>
                            <p>Complete competitive intelligence report</p>
                            <div class="export-options">
                                <button class="btn btn-primary btn-sm" onclick="generateFullReport()">ü§ñ Generate Report</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Market Map Page -->
            <section id="marketmapPage" class="page" aria-label="Market Map">
                <div class="page-header">
                    <h2>üó∫Ô∏è Competitive Market Map</h2>
                    <div class="page-header-actions">
                        <select id="mapViewType" onchange="updateMarketMap()" class="map-view-select"
                            aria-label="Select map view type" title="Select map view type">
                            <option value="threat-size">Threat vs Company Size</option>
                            <option value="category">Product Categories</option>
                            <option value="funding">Funding Stage</option>
                            <option value="geography">Geographic Focus</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportMarketMap()">üì• Export Map</button>
                    </div>
                </div>

                <!-- Market Map Legend -->
                <div class="market-map-legend">
                    <span class="legend-label">Legend:</span>
                    <span class="legend-item"><span class="legend-dot high"></span> High Threat</span>
                    <span class="legend-item"><span class="legend-dot medium"></span> Medium Threat</span>
                    <span class="legend-item"><span class="legend-dot low"></span> Low Threat</span>
                    <span class="legend-item"><span class="legend-square public"></span> Public Company</span>
                    <span class="legend-item"><span class="legend-square private"></span> Private Company</span>
                </div>

                <!-- Main Market Map Visualization -->
                <div class="market-map-grid">
                    <!-- Bubble Chart -->
                    <div class="map-chart-container">
                        <h3 class="map-chart-title">Competitor Positioning</h3>
                        <div class="map-chart-wrapper">
                            <canvas id="marketMapChart"></canvas>
                        </div>
                    </div>

                    <!-- Categories Grid -->
                    <div class="category-sidebar">
                        <div id="categoryBreakdown" class="category-breakdown">
                            <h3 class="category-breakdown-title">By Product Category</h3>
                            <div id="categoryList"><!-- Populated by JS --></div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Company Grid -->
                <div class="intelligence-grid">
                    <h3 class="intelligence-grid-title">üìä Competitor Intelligence Grid</h3>
                    <div class="intel-table-wrapper">
                        <table class="intel-table">
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Status</th>
                                    <th>Threat</th>
                                    <th>Employees</th>
                                    <th>Customers</th>
                                    <th>G2 Rating</th>
                                    <th>Pricing</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="marketMapTable">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Battlecards Page (Deprecated - BC-008) -->
            <section id="battlecardsPage" class="page" aria-label="Battlecards">
                <div class="page-header">
                    <h2>Battlecards</h2>
                    <div id="battlecardsExportContainer" class="page-header-export"></div>
                    <button class="btn btn-secondary" onclick="generateAllBattlecards()">üìÑ Generate All PDFs</button>
                    <button class="btn btn-primary" onclick="startVerifyAllData()">‚úì Verify All Data</button>
                </div>

                <!-- Source Quality Dashboard (v8.3.0) -->
                <div class="glass-panel" id="sourceQualityDashboard" style="margin-bottom: 20px; padding: 16px; border: 1px solid #22c55e;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                        <div>
                            <h3 style="margin: 0 0 4px 0; font-size: 1.05em;">Source Quality</h3>
                            <p style="color: var(--text-secondary); margin: 0; font-size: 0.85em;">Source link quality and verification depth across all competitors.</p>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="btn btn-primary btn-sm" id="refineAllUrlsBtn" onclick="refineAllSourceUrls()">Refine All URLs</button>
                            <button class="btn btn-secondary btn-sm" onclick="rerunContentMatching()" title="Re-run content matching on all sources with force refresh">Re-run Content Matching</button>
                        </div>
                    </div>
                    <div id="sourceQualityStats" class="source-quality-stats" style="margin-top: 12px;">
                        <div class="loading" style="grid-column: 1 / -1;">Loading source quality...</div>
                    </div>
                    <div id="refineProgressContainer" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <span id="refineProgressLabel" style="font-size: 0.82em; color: var(--text-secondary);">Refining URLs...</span>
                            <span id="refineProgressPercent" style="font-size: 0.82em; font-weight: 600; color: var(--primary-color);">0%</span>
                        </div>
                        <div class="refine-progress-bar">
                            <div class="refine-progress-fill" id="refineProgressFill" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <div class="battlecards-grid" id="battlecardsGrid">
                    <!-- Loaded dynamically -->
                </div>
            </section>

            <!-- Sales & Marketing Module Page (v5.0.7) -->
            <section id="salesmarketingPage" class="page" aria-label="Sales and Marketing">
                <div class="page-header">
                    <h2>üéØ Sales & Marketing Module</h2>
                    <p class="page-description">Competitive dimensions, battlecards, and sales enablement tools based on 9 key evaluation criteria</p>
                </div>

                <!-- Sub-navigation Tabs -->
                <div class="sm-module-tabs">
                    <button class="sm-tab-btn active" onclick="showSalesMarketingTab('dimensions')">
                        üìä Dimensions
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('dealintel')">
                        üéØ Deal Intel
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('winthemes')">
                        üèÜ Win Themes
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('objections')">
                        üí¨ Objections
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('battlecards')">
                        ‚öîÔ∏è Battlecards
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('comparison')">
                        üìà Compare
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('talkingpoints')">
                        üìù Talking Pts
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('positioning')">
                        üéØ Positioning
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('quicklookup')">
                        üîç Quick Lookup
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('pricing')">
                        üí∞ Pricing
                    </button>
                    <button class="sm-tab-btn" onclick="showSalesMarketingTab('playbook')">
                        üìñ Playbook
                    </button>
                </div>

                <!-- Tab Content: Dimension Scorecard -->
                <div id="sm-dimensionsTab" class="sm-tab-content active">
                    <div class="sm-filter-bar">
                        <select id="dimensionCompetitorSelect" class="form-select" onchange="loadCompetitorDimensions()">
                            <option value="">-- Select Competitor --</option>
                        </select>
                        <button class="btn btn-secondary" onclick="aiSuggestDimensions()">
                            ü§ñ AI Suggest Scores
                        </button>
                        <button class="btn btn-primary" onclick="saveAllDimensions()">
                            üíæ Save All Changes
                        </button>
                    </div>

                    <!-- Dimension Profile Summary -->
                    <div id="dimensionProfileSummary" class="sm-profile-summary" style="display: none;">
                        <div class="sm-summary-card">
                            <span class="sm-summary-label">Overall Score</span>
                            <span class="sm-summary-value" id="smOverallScore">--</span>
                        </div>
                        <div class="sm-summary-card">
                            <span class="sm-summary-label">Strengths</span>
                            <span class="sm-summary-value sm-strength" id="smStrengthCount">0</span>
                        </div>
                        <div class="sm-summary-card">
                            <span class="sm-summary-label">Weaknesses</span>
                            <span class="sm-summary-value sm-weakness" id="smWeaknessCount">0</span>
                        </div>
                        <div class="sm-summary-card">
                            <span class="sm-summary-label">Sales Priority</span>
                            <span class="sm-summary-value" id="smSalesPriority">--</span>
                        </div>
                    </div>

                    <!-- Dimension Grid -->
                    <div id="dimensionGrid" class="sm-dimension-grid">
                        <p class="sm-placeholder">Select a competitor to view and edit their 9-dimension scorecard.</p>
                    </div>

                    <!-- Dimension History Chart -->
                    <div id="dimensionHistorySection" style="display:none;margin-top:24px;">
                        <div class="chart-card">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                                <h3 style="margin:0;">Dimension Score History</h3>
                                <select id="dimensionHistoryMetric" class="form-select" style="max-width:200px;" onchange="loadDimensionHistory()">
                                    <option value="all">All Dimensions</option>
                                    <option value="product_quality">Product Quality</option>
                                    <option value="market_presence">Market Presence</option>
                                    <option value="innovation">Innovation</option>
                                    <option value="customer_satisfaction">Customer Satisfaction</option>
                                    <option value="pricing_competitiveness">Pricing</option>
                                    <option value="sales_marketing">Sales & Marketing</option>
                                    <option value="partnerships">Partnerships</option>
                                    <option value="financial_stability">Financial Stability</option>
                                    <option value="talent">Talent</option>
                                </select>
                            </div>
                            <div style="position:relative;min-height:250px;">
                                <canvas id="dimensionHistoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Dynamic Battlecards -->
                <div id="sm-battlecardsTab" class="sm-tab-content" style="display: none;">
                    <div class="sm-filter-bar" style="flex-wrap:wrap;">
                        <select id="battlecardCompetitorSelect" class="form-select">
                            <option value="">-- Select Competitor --</option>
                        </select>
                        <select id="battlecardType" class="form-select">
                            <option value="full">Full Battlecard</option>
                            <option value="quick">Quick Reference (1-Page)</option>
                            <option value="objection_handler">Objection Handler</option>
                        </select>
                        <button class="btn btn-primary" onclick="generateDynamicBattlecard()">
                            ‚öîÔ∏è Generate Battlecard
                        </button>
                        <div class="prompt-selector-inline" style="display:flex;align-items:center;gap:6px;width:100%;margin-top:8px;">
                            <label style="font-size:12px;color:#94a3b8;white-space:nowrap;">AI Prompt Template:</label>
                            <select id="battlecardPromptSelect" class="form-select" style="max-width:280px;font-size:12px;padding:4px 8px;"></select>
                            <button class="btn btn-sm btn-secondary" onclick="openPromptViewModal('battlecardPromptSelect','battlecards')" title="View/Edit Prompt" style="padding:4px 8px;font-size:11px;">‚úèÔ∏è</button>
                        </div>
                    </div>
                    <div id="dynamicBattlecardContent" class="sm-battlecard-container">
                        <p class="sm-placeholder">Select a competitor and battlecard type, then click Generate to create a dimension-based battlecard.</p>
                    </div>
                </div>

                <!-- Tab Content: Competitor Comparison -->
                <div id="sm-comparisonTab" class="sm-tab-content" style="display: none;">
                    <div class="sm-filter-bar">
                        <select id="compareCompetitor1" class="form-select">
                            <option value="">-- Select Competitor 1 --</option>
                        </select>
                        <span class="sm-vs-label">vs</span>
                        <select id="compareCompetitor2" class="form-select">
                            <option value="">-- Select Competitor 2 --</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadDimensionComparison()">
                            Compare Dimensions
                        </button>
                        <button class="btn btn-secondary" onclick="compareVsCertify()">
                            üìä vs Certify Health
                        </button>
                    </div>
                    <div id="comparisonContent" class="sm-comparison-container">
                        <canvas id="dimensionRadarChart" style="max-height: 400px;"></canvas>
                        <div id="comparisonDetails" class="sm-comparison-details"></div>
                    </div>
                </div>

                <!-- Tab Content: Talking Points -->
                <div id="sm-talkingpointsTab" class="sm-tab-content" style="display: none;">
                    <div class="sm-filter-bar">
                        <select id="talkingPointsCompetitor" class="form-select" onchange="loadTalkingPoints()">
                            <option value="">-- Select Competitor --</option>
                        </select>
                        <select id="talkingPointsDimension" class="form-select" onchange="loadTalkingPoints()">
                            <option value="">All Dimensions</option>
                        </select>
                        <select id="talkingPointsType" class="form-select" onchange="loadTalkingPoints()">
                            <option value="">All Types</option>
                            <option value="strength">Strengths</option>
                            <option value="weakness">Weaknesses</option>
                            <option value="objection">Objections</option>
                            <option value="counter">Counter-Points</option>
                        </select>
                        <button class="btn btn-secondary" onclick="showAddTalkingPointModal()">
                            ‚ûï Add Talking Point
                        </button>
                    </div>
                    <div id="talkingPointsList" class="sm-talking-points-container">
                        <p class="sm-placeholder">Select a competitor to view talking points organized by dimension.</p>
                    </div>
                </div>

                <!-- Tab Content: Deal Intelligence (SM-007 + BC-004, BC-006, BC-007) -->
                <div id="sm-dealintelTab" class="sm-tab-content" style="display: none;">
                    <div class="sm-filter-bar">
                        <select id="dealIntelCompetitorSelect" class="form-select" onchange="loadDealIntelligence()">
                            <option value="">-- Select Competitor --</option>
                        </select>
                        <div class="deal-room-tabs">
                            <button class="deal-tab-btn active" onclick="showDealRoomTab('overview')">üìä Overview</button>
                            <button class="deal-tab-btn" onclick="showDealRoomTab('news')">üì∞ News & Updates</button>
                            <button class="deal-tab-btn" onclick="showDealRoomTab('pricing')">üí∞ Pricing Intel</button>
                            <button class="deal-tab-btn" onclick="showDealRoomTab('export')">üì• Export Package</button>
                        </div>
                    </div>

                    <!-- Deal Room: Overview Tab (Original SM-007) -->
                    <div id="dealRoom-overviewTab" class="deal-room-content active">
                        <div id="dealIntelContent" class="deal-intel-container">
                            <p class="sm-placeholder">Select a competitor to see their strengths, weaknesses, recent news, and recommended attack strategies.</p>
                        </div>
                    </div>

                    <!-- Deal Room: News & Updates Tab (BC-004) -->
                    <div id="dealRoom-newsTab" class="deal-room-content" style="display: none;">
                        <div id="dealRoomNewsContent" class="deal-room-news-container">
                            <p class="sm-placeholder">Select a competitor to see their latest news and updates.</p>
                        </div>
                    </div>

                    <!-- Deal Room: Pricing Intel Tab (BC-006) -->
                    <div id="dealRoom-pricingTab" class="deal-room-content" style="display: none;">
                        <div id="dealRoomPricingContent" class="deal-room-pricing-container">
                            <p class="sm-placeholder">Select a competitor to see their pricing intelligence.</p>
                        </div>
                    </div>

                    <!-- Deal Room: Export Package Tab (BC-007) -->
                    <div id="dealRoom-exportTab" class="deal-room-content" style="display: none;">
                        <div id="dealRoomExportContent" class="deal-room-export-container">
                            <p class="sm-placeholder">Select a competitor to generate an export package.</p>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Win Themes (SM-004) -->
                <div id="sm-winthemesTab" class="sm-tab-content" style="display: none;">
                    <div class="sm-filter-bar">
                        <select id="winThemesCompetitorSelect" class="form-select">
                            <option value="">-- Select Competitor --</option>
                        </select>
                        <button class="btn btn-primary" onclick="generateWinThemes()">
                            üèÜ Generate Win Themes
                        </button>
                    </div>
                    <div id="winThemesContent" class="win-themes-container">
                        <p class="sm-placeholder">Select a competitor and click "Generate Win Themes" to see AI-powered analysis of why we typically win against them.</p>
                    </div>
                </div>

                <!-- Tab Content: Objection Handler (SM-005) -->
                <div id="sm-objectionsTab" class="sm-tab-content" style="display: none;">
                    <div class="sm-filter-bar">
                        <select id="objectionCompetitorSelect" class="form-select" onchange="loadObjections()">
                            <option value="">-- Select Competitor --</option>
                        </select>
                        <input type="text" id="objectionSearch" class="form-control" placeholder="Search objections..." oninput="searchObjections()">
                        <select id="objectionCategory" class="form-select" onchange="searchObjections()">
                            <option value="">All Categories</option>
                            <option value="Pricing">Pricing</option>
                            <option value="Features">Features</option>
                            <option value="Integration">Integration</option>
                            <option value="Experience">Experience</option>
                            <option value="Security">Security</option>
                            <option value="Support">Support</option>
                        </select>
                    </div>
                    <div id="objectionsList" class="objections-container">
                        <p class="sm-placeholder">Select a competitor to view common objections and proven responses.</p>
                    </div>
                </div>

                <!-- Tab Content: Competitive Positioning Matrix (SM-006) -->
                <div id="sm-positioningTab" class="sm-tab-content" style="display: none;">
                    <div class="sm-filter-bar">
                        <select id="positioningXAxis" class="form-select" onchange="updatePositioningMatrix()">
                            <option value="pricing_flexibility">X-Axis: Pricing</option>
                            <option value="product_packaging">X-Axis: Product Packaging</option>
                            <option value="integration_depth">X-Axis: Integration</option>
                            <option value="support_service">X-Axis: Support</option>
                        </select>
                        <select id="positioningYAxis" class="form-select" onchange="updatePositioningMatrix()">
                            <option value="product_packaging">Y-Axis: Functionality</option>
                            <option value="integration_depth">Y-Axis: Integration</option>
                            <option value="reliability_enterprise">Y-Axis: Enterprise Ready</option>
                            <option value="user_adoption">Y-Axis: Adoption</option>
                        </select>
                        <select id="positioningBubbleSize" class="form-select" onchange="updatePositioningMatrix()">
                            <option value="threat">Bubble Size: Threat Level</option>
                            <option value="overall">Bubble Size: Overall Score</option>
                            <option value="equal">Bubble Size: Equal</option>
                        </select>
                        <button class="btn btn-secondary" onclick="exportPositioningMatrix()">
                            üìä Export Chart
                        </button>
                    </div>
                    <div class="positioning-matrix-container">
                        <div class="positioning-legend">
                            <span class="legend-item"><span class="legend-dot high-threat"></span> High Threat</span>
                            <span class="legend-item"><span class="legend-dot medium-threat"></span> Medium Threat</span>
                            <span class="legend-item"><span class="legend-dot low-threat"></span> Low Threat</span>
                            <span class="legend-item certify-marker">‚òÖ Certify Health</span>
                        </div>
                        <canvas id="positioningMatrixChart" style="height: 500px;"></canvas>
                        <div id="positioningInsights" class="positioning-insights">
                            <p class="sm-placeholder">Loading competitive positioning matrix...</p>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Quick Competitive Lookup (SM-008) -->
                <div id="sm-quicklookupTab" class="sm-tab-content" style="display: none;">
                    <div class="quick-lookup-container">
                        <div class="quick-lookup-header">
                            <h3>üîç Quick Competitive Lookup</h3>
                            <p>Get an instant AI summary of everything you need to know about a competitor</p>
                        </div>
                        <div class="quick-lookup-search">
                            <div class="lookup-input-group">
                                <select id="quickLookupCompetitor" class="form-select form-select-lg">
                                    <option value="">-- Select Competitor --</option>
                                </select>
                                <button class="btn btn-primary btn-lg" onclick="performQuickLookup()">
                                    ü§ñ What Should I Know?
                                </button>
                            </div>
                            <div class="lookup-quick-actions">
                                <button class="btn btn-sm btn-outline" onclick="quickLookupCategory('strengths')">Their Strengths</button>
                                <button class="btn btn-sm btn-outline" onclick="quickLookupCategory('weaknesses')">Their Weaknesses</button>
                                <button class="btn btn-sm btn-outline" onclick="quickLookupCategory('pricing')">Pricing Intel</button>
                                <button class="btn btn-sm btn-outline" onclick="quickLookupCategory('news')">Recent News</button>
                                <button class="btn btn-sm btn-outline" onclick="quickLookupCategory('objections')">Common Objections</button>
                            </div>
                        </div>
                        <div id="quickLookupResult" class="quick-lookup-result">
                            <p class="sm-placeholder">Select a competitor and click "What Should I Know?" for an AI-powered briefing.</p>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Pricing Comparison Calculator (SM-009) -->
                <div id="sm-pricingTab" class="sm-tab-content" style="display: none;">
                    <div class="pricing-calculator-container">
                        <div class="pricing-header">
                            <h3>üí∞ Pricing Comparison Calculator</h3>
                            <p>Compare pricing across competitors with TCO analysis</p>
                        </div>
                        <div class="pricing-setup">
                            <div class="pricing-setup-card">
                                <h4>Deal Parameters</h4>
                                <div class="pricing-form-grid">
                                    <div class="form-group">
                                        <label>Number of Users</label>
                                        <input type="number" id="pricingUsers" class="form-control" value="100" min="1" onchange="calculatePricing()">
                                    </div>
                                    <div class="form-group">
                                        <label>Contract Length</label>
                                        <select id="pricingContractLength" class="form-select" onchange="calculatePricing()">
                                            <option value="1">1 Year</option>
                                            <option value="2">2 Years</option>
                                            <option value="3" selected>3 Years</option>
                                            <option value="5">5 Years</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Implementation Scope</label>
                                        <select id="pricingImplementation" class="form-select" onchange="calculatePricing()">
                                            <option value="basic">Basic</option>
                                            <option value="standard" selected>Standard</option>
                                            <option value="enterprise">Enterprise</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Support Level</label>
                                        <select id="pricingSupport" class="form-select" onchange="calculatePricing()">
                                            <option value="standard">Standard</option>
                                            <option value="premium" selected>Premium</option>
                                            <option value="dedicated">Dedicated</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="pricing-setup-card">
                                <h4>Compare Against</h4>
                                <div class="pricing-competitor-select">
                                    <select id="pricingCompetitor1" class="form-select" onchange="calculatePricing()">
                                        <option value="">-- Select Competitor 1 --</option>
                                    </select>
                                    <select id="pricingCompetitor2" class="form-select" onchange="calculatePricing()">
                                        <option value="">-- Select Competitor 2 --</option>
                                    </select>
                                    <select id="pricingCompetitor3" class="form-select" onchange="calculatePricing()">
                                        <option value="">-- Select Competitor 3 --</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="pricingComparisonResult" class="pricing-comparison-result">
                            <p class="sm-placeholder">Configure deal parameters and select competitors to see pricing comparison.</p>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Sales Playbook Generator (SM-010) -->
                <div id="sm-playbookTab" class="sm-tab-content" style="display: none;">
                    <div class="playbook-container">
                        <div class="playbook-header">
                            <h3>üìñ Sales Playbook Generator</h3>
                            <p>Generate customized call scripts and email templates based on competitor context</p>
                        </div>
                        <div class="playbook-setup">
                            <div class="playbook-setup-row">
                                <div class="form-group">
                                    <label>Competitor</label>
                                    <select id="playbookCompetitor" class="form-select" onchange="updatePlaybookContext()">
                                        <option value="">-- Select Competitor --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Scenario</label>
                                    <select id="playbookScenario" class="form-select">
                                        <option value="displacement">Competitive Displacement</option>
                                        <option value="headtohead">Head-to-Head Evaluation</option>
                                        <option value="incumbent">We're Incumbent (Defense)</option>
                                        <option value="followup">Post-Demo Follow-up</option>
                                        <option value="objection">Handling Objection</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Content Type</label>
                                    <select id="playbookType" class="form-select">
                                        <option value="call_script">Discovery Call Script</option>
                                        <option value="email_initial">Initial Outreach Email</option>
                                        <option value="email_followup">Follow-up Email</option>
                                        <option value="objection_response">Objection Response</option>
                                        <option value="value_prop">Value Proposition</option>
                                        <option value="executive_summary">Executive Summary</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary btn-lg" onclick="generatePlaybook()">
                                    ü§ñ Generate Playbook
                                </button>
                            </div>
                            <div class="form-group" style="margin-top:12px;">
                                <label>Deal Context <span style="font-size:11px;color:var(--text-secondary);">(optional)</span></label>
                                <textarea id="playbookDealContext" class="form-control" rows="3" placeholder="Add deal-specific context: prospect name, deal size, key concerns, timeline, stakeholders..." style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--bg-tertiary, #0f172a);color:var(--text-primary);font-size:13px;resize:vertical;"></textarea>
                            </div>
                            <div class="playbook-context-summary" id="playbookContextSummary">
                                <p class="sm-placeholder">Select a competitor to see context summary.</p>
                            </div>
                        </div>
                        <div id="playbookResult" class="playbook-result">
                            <p class="sm-placeholder">Configure options above and click "Generate Playbook" to create customized sales content.</p>
                        </div>
                        <div id="playbookExportActions" style="display:none;margin-top:12px;text-align:right;">
                            <button class="btn btn-secondary btn-sm" onclick="exportPlaybookPDF()">üìÑ Export as PDF</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Page -->
            <section id="reportsPage" class="page">
                <div class="page-header">
                    <h2>Reports</h2>
                </div>
                <div class="reports-grid">
                    <div class="report-card">
                        <div class="report-icon">üìä</div>
                        <h3>Executive Briefing</h3>
                        <p>Weekly summary for leadership</p>
                        <button class="btn btn-primary"
                            onclick="window.open(`${window.location.origin}/api/reports/weekly-briefing`, '_blank')">Generate
                            PDF</button>
                    </div>
                    <div class="report-card">
                        <div class="report-icon">‚öñÔ∏è</div>
                        <h3>Comparison Report</h3>
                        <p>Side-by-side competitor analysis</p>
                        <button class="btn btn-primary"
                            onclick="window.open(`${window.location.origin}/api/reports/comparison`, '_blank')">Generate
                            PDF</button>
                    </div>
                    <div class="report-card">
                        <div class="report-icon">üì•</div>
                        <h3>Excel Export</h3>
                        <p>Full data export for Excel</p>
                        <button class="btn btn-primary"
                            onclick="window.location.href=`${window.location.origin}/api/export/excel`">Download</button>
                    </div>
                    <div class="report-card">
                        <div class="report-icon">{ }</div>
                        <h3>JSON Export</h3>
                        <p>For Power Query integration</p>
                        <button class="btn btn-secondary"
                            onclick="window.location.href=`${window.location.origin}/api/export/json`">Download</button>
                    </div>
            </section>

            <!-- Data Quality Page -->
            <section id="dataqualityPage" class="page" aria-label="Validation">
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2>Validation</h2>
                        <p>Monitor data completeness, confidence scores, and source attribution across all competitors</p>
                    </div>
                    <div id="dqHeaderActions" style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="recalculateAllConfidence()">üîÑ Recalculate Scores</button>
                        <button class="btn btn-primary" onclick="verifyAllRecords()">‚úÖ Mark All Verified</button>
                        <button class="btn btn-secondary" onclick="exportQualityReport()">üìä Export Report</button>
                    </div>
                </div>

                <!-- Validation Tabs -->
                <div class="validation-tab-bar">
                    <button class="validation-tab-btn active" onclick="showValidationTab('dataquality')">
                        Data Validation
                    </button>
                    <button class="validation-tab-btn" onclick="showValidationTab('kbimport')">
                        Knowledge Base Import
                    </button>
                </div>

                <!-- Tab 1: Data Validation (existing content) -->
                <div id="dq-dataqualityTab" class="validation-tab-content active">

                <!-- Quality Summary Cards - Row 1: Core Metrics -->
                <div class="stats-grid" style="margin-bottom: 1rem;">
                    <div class="stat-card stat-card-clickable" onclick="showQualityDetails('completeness')">
                        <div class="stat-value" id="overallCompleteness">0%</div>
                        <div class="stat-label">Overall Completeness</div>
                    </div>
                    <div class="stat-card stat-card-clickable" onclick="showQualityDetails('scores')">
                        <div class="stat-value" id="avgQualityScore">0</div>
                        <div class="stat-label">Avg Quality Score</div>
                    </div>
                    <div class="stat-card stat-card-clickable" onclick="showQualityDetails('stale')"
                        style="border-left: 4px solid #dc3545;">
                        <div class="stat-value" id="staleCount" style="color: #dc3545;">0</div>
                        <div class="stat-label">Stale Records</div>
                    </div>
                    <div class="stat-card stat-card-clickable" onclick="showQualityDetails('fresh')"
                        style="border-left: 4px solid #22c55e;">
                        <div class="stat-value" id="freshCount" style="color: #22c55e;">0</div>
                        <div class="stat-label">Fresh Records</div>
                    </div>
                </div>

                <!-- Confidence Distribution Cards - Row 2 -->
                <div class="stats-grid confidence-stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card confidence-stat-card" onclick="filterByConfidence('high')" style="border-left: 4px solid #10b981;">
                        <div class="stat-value confidence-high-value" id="highConfidenceCount">0</div>
                        <div class="stat-label">High Confidence</div>
                        <div class="stat-sub" id="highConfidencePercent" style="color: #10b981; font-size: 12px;">0% of data</div>
                    </div>
                    <div class="stat-card confidence-stat-card" onclick="filterByConfidence('moderate')" style="border-left: 4px solid #f59e0b;">
                        <div class="stat-value confidence-moderate-value" id="moderateConfidenceCount">0</div>
                        <div class="stat-label">Moderate Confidence</div>
                        <div class="stat-sub" id="moderateConfidencePercent" style="color: #f59e0b; font-size: 12px;">0% of data</div>
                    </div>
                    <div class="stat-card confidence-stat-card" onclick="filterByConfidence('low')" style="border-left: 4px solid #ef4444;">
                        <div class="stat-value confidence-low-value" id="lowConfidenceCount">0</div>
                        <div class="stat-label">Low Confidence</div>
                        <div class="stat-sub" id="lowConfidencePercent" style="color: #ef4444; font-size: 12px;">0% of data</div>
                    </div>
                    <div class="stat-card confidence-stat-card" onclick="showQualityDetails('verified')">
                        <div class="stat-value" id="verificationRate">0%</div>
                        <div class="stat-label">Verification Rate</div>
                        <div class="stat-sub" id="verifiedCount" style="color: #64748b; font-size: 12px;">0 verified</div>
                    </div>
                </div>

                <!-- Charts Row - Enhanced with Confidence Distribution -->
                <div class="charts-row" style="margin-bottom: 2rem;">
                    <div class="chart-card">
                        <h3>Quality Tier Distribution</h3>
                        <canvas id="qualityTierChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Confidence Distribution</h3>
                        <canvas id="confidenceDistributionChart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>Field Coverage Overview</h3>
                        <canvas id="fieldCoverageChart"></canvas>
                    </div>
                </div>

                <!-- Source Type Breakdown -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3>üìä Source Type Breakdown</h3>
                            <p style="color: var(--text-secondary);">Data points by source type with average confidence scores</p>
                        </div>
                    </div>
                    <div id="sourceTypeBreakdown" class="source-type-grid">
                        <div class="loading">Loading source breakdown...</div>
                    </div>
                </div>

                <!-- Field Confidence Analysis -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3>üìã Field Coverage with Confidence</h3>
                            <p style="color: var(--text-secondary);">Key fields tracked with coverage percentage and average confidence</p>
                        </div>
                    </div>
                    <div id="fieldConfidenceAnalysis" class="field-confidence-grid">
                        <div class="loading">Loading field analysis...</div>
                    </div>
                </div>

                <!-- Competitor Quality Ranking -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3>üèÜ Competitor Data Quality Ranking</h3>
                            <p style="color: var(--text-secondary);">Competitors ranked by average confidence score</p>
                        </div>
                        <select id="qualityRankingFilter" onchange="filterQualityRanking()" style="padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border-color);">
                            <option value="all">All Tiers</option>
                            <option value="Excellent">Excellent (70+)</option>
                            <option value="Good">Good (50-69)</option>
                            <option value="Fair">Fair (30-49)</option>
                            <option value="Poor">Poor (&lt;30)</option>
                        </select>
                    </div>
                    <div id="competitorQualityRanking" style="max-height: 400px; overflow-y: auto;">
                        <div class="loading">Loading competitor rankings...</div>
                    </div>
                </div>

                <!-- Field Completeness Section -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3>Field Completeness by Data Point</h3>
                            <p style="color: var(--text-secondary);">Percentage of competitors with valid data for each
                                field</p>
                        </div>
                        <select id="fieldFilter" onchange="filterFields()"
                            style="padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border-color);">
                            <option value="all">All Fields</option>
                            <option value="low">Low (&lt;60%)</option>
                            <option value="medium">Medium (60-80%)</option>
                            <option value="high">High (&gt;80%)</option>
                        </select>
                    </div>
                    <div id="fieldCompleteness"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                        <div class="loading">Loading field completeness...</div>
                    </div>
                </div>

                <!-- Quality Scores Section -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3>Competitor Quality Scores</h3>
                            <p style="color: var(--text-secondary);">Data quality scores (0-100) for each competitor</p>
                        </div>
                        <select id="scoreFilter" onchange="filterScores()"
                            style="padding: 8px 12px; border-radius: 4px; border: 1px solid var(--border-color);">
                            <option value="all">All Tiers</option>
                            <option value="Excellent">Excellent (90+)</option>
                            <option value="Good">Good (70-89)</option>
                            <option value="Fair">Fair (50-69)</option>
                            <option value="Poor">Poor (&lt;50)</option>
                        </select>
                    </div>
                    <div id="qualityScores" style="max-height: 400px; overflow-y: auto;">
                        <div class="loading">Loading quality scores...</div>
                    </div>
                </div>

                <!-- P2-3: Data Conflicts Section -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3>‚öîÔ∏è Data Conflicts</h3>
                            <p style="color: var(--text-secondary);">KB extractions that conflict with live data - requires human review</p>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <span id="conflictCount" class="conflict-count-badge" style="background: #fee2e2; color: #dc2626; padding: 4px 12px; border-radius: 20px; font-weight: 600;">0 conflicts</span>
                            <button class="btn btn-secondary" onclick="loadDataConflicts()" style="font-size: 0.85em;">üîÑ Refresh</button>
                        </div>
                    </div>
                    <div id="dataConflicts" style="max-height: 500px; overflow-y: auto;">
                        <div class="loading">Loading data conflicts...</div>
                    </div>
                </div>

                <!-- Stale Data Section -->
                <div class="card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3>‚ö†Ô∏è Stale Data Alerts</h3>
                            <p style="color: var(--text-secondary);">Competitors with data not verified in the last 30
                                days</p>
                        </div>
                        <button class="btn btn-secondary" onclick="refreshStaleData()" style="font-size: 0.85em;">üîÑ
                            Refresh</button>
                    </div>
                    <div id="staleRecords">
                        <div class="loading">Loading stale records...</div>
                    </div>
                </div>
                </div><!-- /dq-dataqualityTab -->

                <!-- Tab 2: Knowledge Base Import -->
                <div id="dq-kbimportTab" class="validation-tab-content">
                    <!-- Scan Panel -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3>Scan Knowledge Base</h3>
                                <p style="color: var(--text-secondary);">Scan the knowledge base directory for importable files</p>
                            </div>
                            <button class="btn btn-primary" id="kbScanBtn" onclick="scanKnowledgeBase()">Scan Files</button>
                        </div>
                        <div id="kbScanProgress" style="display: none;">
                            <div class="loading">Scanning knowledge base files...</div>
                        </div>
                        <div id="kbScanResults" style="display: none;">
                            <div id="kbFileList"></div>
                        </div>
                    </div>

                    <!-- Preview Panel -->
                    <div class="card" id="kbPreviewPanel" style="margin-bottom: 2rem; display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3>Import Preview</h3>
                                <p style="color: var(--text-secondary);">Review what will be imported before proceeding</p>
                            </div>
                            <button class="btn btn-secondary" onclick="previewKnowledgeBase()">Refresh Preview</button>
                        </div>
                        <!-- Preview stats -->
                        <div class="stats-grid" id="kbPreviewStats" style="margin-bottom: 1rem;">
                        </div>
                        <!-- Preview warnings -->
                        <div id="kbPreviewWarnings" style="display: none; margin-bottom: 1rem;"></div>
                        <!-- Preview errors -->
                        <div id="kbPreviewErrors" style="display: none; margin-bottom: 1rem;"></div>
                        <!-- Preview table -->
                        <div id="kbPreviewTable" style="max-height: 400px; overflow-y: auto;"></div>
                    </div>

                    <!-- Import Controls -->
                    <div class="card" id="kbImportPanel" style="margin-bottom: 2rem; display: none;">
                        <div style="margin-bottom: 1rem;">
                            <h3>Import Data</h3>
                            <p style="color: var(--text-secondary);">Import parsed data into the competitor database</p>
                        </div>
                        <div style="display: flex; gap: 24px; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
                            <label class="kb-checkbox-label">
                                <input type="checkbox" id="kbDryRun" checked>
                                <span>Dry Run</span>
                                <span style="font-size: 11px; color: var(--text-secondary);">(preview changes without saving)</span>
                            </label>
                            <label class="kb-checkbox-label">
                                <input type="checkbox" id="kbOverwrite">
                                <span>Overwrite Existing</span>
                                <span style="font-size: 11px; color: var(--text-secondary);">(update data for existing competitors)</span>
                            </label>
                            <button class="btn btn-primary" id="kbImportBtn" onclick="importKnowledgeBase()">Run Import</button>
                        </div>
                        <div id="kbImportProgress" style="display: none;">
                            <div class="loading">Running import...</div>
                        </div>
                        <div id="kbImportResults" style="display: none;"></div>
                    </div>

                    <!-- Verification Queue -->
                    <div class="card" style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3>Verification Queue</h3>
                                <p style="color: var(--text-secondary);">Imported data points awaiting verification</p>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" id="kbBulkApproveBtn" onclick="bulkApproveKbItems()" style="display: none;">Bulk Approve Selected</button>
                                <button class="btn btn-secondary" onclick="loadKbVerificationQueue()">Load Queue</button>
                            </div>
                        </div>
                        <div id="kbVerificationQueue">
                            <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <p>Click "Load Queue" to view pending verification items.</p>
                            </div>
                        </div>
                    </div>
                </div><!-- /dq-kbimportTab -->

            </section>

            <!-- Reports & Visualization Page -->
            <section id="reportsPage" class="page">
                <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2>Reports & Visualization</h2>
                        <p class="subtitle">Advanced competitive intelligence visualization and strategic reporting.</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="downloadExecutiveReport()">
                            <i class="fas fa-file-pdf"></i> Download Executive Summary
                        </button>
                    </div>
                </div>

                <!-- Positioning Matrix Section -->
                <div class="card full-width-card" style="margin-bottom: 2rem;">
                    <div class="card-header"
                        style="display: flex; justify-content: space-between; align-items: center;">
                        <h3><i class="fas fa-crosshairs"></i> Competitive Positioning Matrix</h3>
                        <div class="card-actions">
                            <select id="matrix-x-axis" onchange="updatePositioningMatrix()" style="padding: 4px;">
                                <option value="price">Price</option>
                                <option value="employees">Company Size</option>
                            </select>
                            <span>vs</span>
                            <select id="matrix-y-axis" onchange="updatePositioningMatrix()" style="padding: 4px;">
                                <option value="satisfaction">G2 Satisfaction</option>
                                <option value="market_presence">Market Presence</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 500px; position: relative;">
                        <canvas id="positioningMatrixChart"></canvas>
                    </div>
                    <div class="chart-legend" style="text-align: center; margin-top: 10px;">
                        <small>Size of bubble represents Market Share (Customer Count)</small>
                    </div>
                </div>

                <div class="grid-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- SWOT Analysis Generator -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chess-knight"></i> AI Strategic SWOT Analysis</h3>
                        </div>
                        <div class="form-group" style="margin-bottom: 15px;">
                            <label>Select Competitor via AI</label>
                            <select id="swot-competitor-select" class="form-control" onchange="generateSWOT()"
                                style="width: 100%; padding: 8px;">
                                <option value="">Select a competitor...</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div class="prompt-selector-inline" style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                            <label style="font-size:12px;color:#94a3b8;white-space:nowrap;">SWOT Prompt:</label>
                            <select id="competitorPromptSelect" class="form-select" style="max-width:260px;font-size:12px;padding:4px 8px;"></select>
                            <button class="btn btn-sm btn-secondary" onclick="openPromptViewModal('competitorPromptSelect','competitor')" title="View/Edit Prompt" style="padding:4px 8px;font-size:11px;">‚úèÔ∏è</button>
                        </div>
                        <div id="swot-loading" class="loading-spinner"
                            style="display: none; text-align: center; padding: 20px;">
                            <i class="fas fa-circle-notch fa-spin"></i> Generating analysis...
                        </div>
                        <div id="swot-content" class="swot-container">
                            <div class="swot-grid">
                            </div>
                        </div>
                    </div>

                    <!-- Market Trend Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-area"></i> Market Trends</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="marketTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Page -->
            <section id="settingsPage" class="page" aria-label="Settings">
                <div class="page-header">
                    <h2>Settings</h2>
                </div>
                <div class="settings-grid">
                    <!-- Account Security -->
                    <div class="settings-card">
                        <h3>üîë Change Password</h3>
                        <div class="settings-form" id="passwordChangeForm">
                            <div class="form-group">
                                <label for="currentPassword">Current Password</label>
                                <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password" autocomplete="current-password">
                            </div>
                            <div class="form-group">
                                <label for="newPassword">New Password</label>
                                <input type="password" id="newPassword" class="form-input" placeholder="Min 8 characters" autocomplete="new-password">
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">Confirm New Password</label>
                                <input type="password" id="confirmPassword" class="form-input" placeholder="Re-enter new password" autocomplete="new-password">
                            </div>
                            <div id="passwordChangeMsg" style="margin-bottom:8px;font-size:13px;"></div>
                            <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
                        </div>
                    </div>

                    <!-- MFA Setup -->
                    <div class="settings-card">
                        <h3>üõ°Ô∏è Two-Factor Authentication</h3>
                        <div id="mfaStatusSection">
                            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                                <span id="mfaStatusBadge" class="status-badge">Loading...</span>
                                <span id="mfaStatusText" style="color:var(--text-secondary);font-size:13px;">Checking MFA status...</span>
                            </div>
                            <div id="mfaSetupArea">
                                <button id="mfaEnableBtn" class="btn btn-primary btn-sm" onclick="enableMFA()" style="display:none;">Enable MFA</button>
                                <button id="mfaDisableBtn" class="btn btn-secondary btn-sm" onclick="disableMFA()" style="display:none;">Disable MFA</button>
                            </div>
                            <div id="mfaQRSection" style="display:none;margin-top:16px;text-align:center;">
                                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">Scan this QR code with your authenticator app:</p>
                                <div id="mfaQRCode" style="display:inline-block;padding:16px;background:#fff;border-radius:8px;"></div>
                                <div style="margin-top:12px;">
                                    <input type="text" id="mfaVerifyCode" class="form-input" placeholder="Enter 6-digit code" maxlength="6" style="width:200px;text-align:center;display:inline-block;">
                                    <button class="btn btn-primary btn-sm" onclick="verifyMFA()">Verify</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Log Viewer -->
                    <div class="settings-card full-width">
                        <h3>üìã Audit Log</h3>
                        <p style="color:var(--text-secondary);margin-bottom:12px;">Searchable history of user actions and system events</p>
                        <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center;">
                            <input type="text" id="auditLogSearch" class="form-input" placeholder="Search actions..." style="flex:1;min-width:200px;" oninput="filterAuditLogs()">
                            <select id="auditLogActionFilter" class="form-select" style="min-width:150px;" onchange="filterAuditLogs()">
                                <option value="">All Actions</option>
                                <option value="login">Login</option>
                                <option value="create">Create</option>
                                <option value="update">Update</option>
                                <option value="delete">Delete</option>
                                <option value="export">Export</option>
                            </select>
                            <button class="btn btn-secondary btn-sm" onclick="loadAuditLogs()">Refresh</button>
                        </div>
                        <div id="auditLogContainer" style="overflow-y:auto;max-height:400px;">
                            <table class="competitor-list-table" id="auditLogTable">
                                <thead><tr>
                                    <th>Timestamp</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Details</th>
                                </tr></thead>
                                <tbody id="auditLogBody">
                                    <tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:24px;">Loading audit logs...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="settings-card full-width">
                        <h3>üîî Alert Rules Engine</h3>
                        <p>Configure intelligent alerts for competitive events</p>
                        <div class="alert-rules-header">
                            <div class="alert-stats">
                                <span class="alert-stat" id="activeRulesCount">0 active rules</span>
                                <span class="alert-stat" id="alertsTodayCount">0 alerts today</span>
                            </div>
                            <button class="btn btn-primary" onclick="showAddRuleModal()">+ Create Alert Rule</button>
                        </div>
                        <div id="alertRulesList" class="alert-rules-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- FEAT-008: AI Insight Summaries -->
                    <div class="settings-card full-width">
                        <h3>ü§ñ AI Insight Summaries</h3>
                        <p>Configure automated AI-generated intelligence briefs</p>
                        <div class="ai-insights-config">
                            <div class="config-row">
                                <span class="config-label">Daily Digest</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="dailyDigestToggle" onchange="saveAIInsightSettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="config-description">Receive an AI summary every morning at 8 AM</span>
                            </div>
                            <div class="config-row">
                                <span class="config-label">Weekly Briefing</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="weeklyBriefingToggle" checked onchange="saveAIInsightSettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="config-description">Comprehensive weekly competitive analysis on Mondays</span>
                            </div>
                            <div class="config-row">
                                <span class="config-label">Real-time Alerts</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="realtimeAlertsToggle" onchange="saveAIInsightSettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="config-description">AI-analyzed alerts for significant competitor events</span>
                            </div>
                            <div class="config-row">
                                <span class="config-label">Include Recommendations</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="includeRecommendationsToggle" checked onchange="saveAIInsightSettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="config-description">Add strategic recommendations to insights</span>
                            </div>
                        </div>
                        <div class="ai-insights-actions">
                            <button class="btn btn-secondary" onclick="generateManualInsight('daily')">
                                üìã Generate Daily Digest Now
                            </button>
                            <button class="btn btn-secondary" onclick="generateManualInsight('weekly')">
                                üìä Generate Weekly Briefing Now
                            </button>
                        </div>
                    </div>
                    <!-- Webhooks Admin -->
                    <div class="settings-card full-width">
                        <div class="webhooks-header">
                            <div>
                                <h3>üîó Webhooks</h3>
                                <p>Send real-time notifications to external services when competitive events occur</p>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="showAddWebhookForm()">+ Add Webhook</button>
                        </div>
                        <!-- Add webhook form (hidden by default) -->
                        <div id="addWebhookForm" class="webhook-form" style="display:none;">
                            <div class="webhook-form-row">
                                <label>Name</label>
                                <input type="text" id="webhookName" placeholder="e.g. Slack Alerts" class="form-input">
                            </div>
                            <div class="webhook-form-row">
                                <label>URL</label>
                                <input type="url" id="webhookUrl" placeholder="https://hooks.slack.com/..." class="form-input">
                            </div>
                            <div class="webhook-form-row">
                                <label>Event Types</label>
                                <div id="webhookEventTypes" class="webhook-events-grid">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            <div class="webhook-form-actions">
                                <button class="btn btn-secondary btn-sm" onclick="hideAddWebhookForm()">Cancel</button>
                                <button class="btn btn-primary btn-sm" onclick="saveWebhook()">Save Webhook</button>
                            </div>
                        </div>
                        <!-- Webhooks table -->
                        <div id="webhooksTableContainer">
                            <div class="loading">Loading webhooks...</div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3>Integrations</h3>
                        <div class="integration-item">
                            <span>Slack</span>
                            <span class="status-badge" id="slackStatus">Not Configured</span>
                        </div>
                        <div class="integration-item">
                            <span>Microsoft Teams</span>
                            <span class="status-badge" id="teamsStatus">Not Configured</span>
                        </div>
                        <div class="integration-item">
                            <span>SMS (Twilio)</span>
                            <span class="status-badge" id="smsStatus">Not Configured</span>
                        </div>
                    </div>
                    <div class="settings-card">
                        <h3>Scheduler</h3>
                        <div class="schedule-item">
                            <span>Weekly Full Refresh</span>
                            <span>Sundays 2:00 AM</span>
                        </div>
                        <div class="schedule-item">
                            <span>Daily High-Priority Check</span>
                            <span>Daily 6:00 AM</span>
                        </div>
                    </div>
                    <div class="settings-card full-width">
                        <h3>Team Management</h3>
                        <div class="team-mgmt-header">
                            <div class="team-mgmt-header-left">
                                <p style="margin: 0; color: var(--text-secondary);">Manage teams, members, and roles.</p>
                                <div id="teamSelector" class="team-selector" style="display: none;"></div>
                            </div>
                            <div class="team-mgmt-header-actions">
                                <button class="btn btn-secondary btn-sm" onclick="showCreateTeamModal()">+ New Team</button>
                                <button class="btn btn-primary btn-sm" onclick="showInviteUserModal()">+ Invite Member</button>
                            </div>
                        </div>
                        <div id="teamList">
                            <div class="loading">Loading team...</div>
                        </div>
                    </div>
                    <div class="settings-card full-width">
                        <h3>Team Activity Feed</h3>
                        <p style="color: var(--text-secondary);">Recent annotation and collaboration activity across your teams</p>
                        <div id="teamActivityFeed">
                            <div class="loading">Loading activity...</div>
                        </div>
                        <div id="teamActivityMore" style="display: none; text-align: center; padding: 8px 0;">
                            <button class="btn btn-sm btn-secondary" onclick="loadTeamActivity(20)">View More</button>
                        </div>
                    </div>
                </div>

                <!-- AI Provider Settings (v8.3.0) -->
                <div class="settings-card full-width icon-card" id="aiProviderSettings" style="border: 1px solid #10B981;">
                    <h3>ü§ñ AI Provider Configuration</h3>
                    <p style="margin-bottom: 15px;">Configure which AI provider to use for different tasks. <span id="aiProviderVersion" style="color: var(--text-secondary); font-size: 0.85em;">v8.3.0</span></p>

                    <div id="aiProviderStatus" class="ai-provider-status" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- OpenAI Status -->
                        <div class="provider-card" style="background: var(--glass-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: white; font-size: 16px;">‚ú¶</span>
                                </div>
                                <div>
                                    <strong>OpenAI</strong>
                                    <div id="openaiStatusBadge" class="status-badge" style="margin-left: 0;">Checking...</div>
                                </div>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">
                                Model: <span id="openaiModel">gpt-4o-mini</span>
                            </div>
                        </div>

                        <!-- Gemini Status -->
                        <div class="provider-card" style="background: var(--glass-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #4285F4 0%, #8E44AD 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: white; font-size: 16px;">‚óá</span>
                                </div>
                                <div>
                                    <strong>Google Gemini</strong>
                                    <div id="geminiStatusBadge" class="status-badge" style="margin-left: 0;">Checking...</div>
                                </div>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">
                                Model: <span id="geminiModel">gemini-3-flash-preview</span>
                            </div>
                        </div>

                        <!-- Anthropic (Claude) Status -->
                        <div class="provider-card" style="background: var(--glass-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #D97706 0%, #B45309 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: white; font-size: 16px;">&#9670;</span>
                                </div>
                                <div>
                                    <strong>Anthropic Claude</strong>
                                    <div id="anthropicStatusBadge" class="status-badge" style="margin-left: 0;">Checking...</div>
                                </div>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">
                                Model: <span id="anthropicModel">claude-opus-4-5</span>
                            </div>
                        </div>

                        <!-- DeepSeek Status -->
                        <div class="provider-card" style="background: var(--glass-bg); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #0EA5E9 0%, #0284C7 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: white; font-size: 16px;">&#9671;</span>
                                </div>
                                <div>
                                    <strong>DeepSeek</strong>
                                    <div id="deepseekStatusBadge" class="status-badge" style="margin-left: 0;">Checking...</div>
                                </div>
                            </div>
                            <div style="font-size: 0.85em; color: var(--text-secondary);">
                                Model: <span id="deepseekModel">deepseek-chat</span>
                            </div>
                        </div>
                    </div>

                    <!-- Task Routing Display -->
                    <div id="aiTaskRouting" style="background: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 0.95em;">Task Routing</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 0.85em;">
                            <div>
                                <span style="color: var(--text-secondary);">Data Extraction:</span>
                                <span id="routingExtraction" style="font-weight: 500; text-transform: capitalize;">-</span>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Executive Summary:</span>
                                <span id="routingSummary" style="font-weight: 500; text-transform: capitalize;">-</span>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Bulk Tasks:</span>
                                <span id="routingBulk" style="font-weight: 500; text-transform: capitalize;">-</span>
                            </div>
                            <div>
                                <span style="color: var(--text-secondary);">Quality Tasks:</span>
                                <span id="routingQuality" style="font-weight: 500; text-transform: capitalize;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- System Readiness (v8.3.1) -->
                    <div id="systemReadinessPanel" style="background: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 0.95em;">System Readiness</h4>
                        <div id="systemReadinessContent">
                            <div class="loading" style="font-size: 0.85em;">Checking system readiness...</div>
                        </div>
                    </div>

                    <div style="font-size: 0.85em; color: var(--text-secondary);">
                        <strong>Note:</strong> AI provider settings are configured via environment variables. Edit <code>.env</code> to change providers.
                        <br>‚Ä¢ <code>AI_PROVIDER=hybrid</code> - Smart routing across all providers (recommended)
                        <br>‚Ä¢ <code>AI_QUALITY_TASKS=anthropic</code> - Claude for complex analysis
                        <br>‚Ä¢ <code>AI_BULK_TASKS=gemini</code> - Gemini for speed/cost tasks
                        <br>‚Ä¢ <code>AI_FALLBACK_ENABLED=true</code> - Auto-failover between providers
                    </div>
                </div>

                <!-- Enterprise Data Providers (v8.3.0) -->
                <div class="settings-card full-width icon-card" id="dataProvidersSettings" style="border: 1px solid #8b5cf6;">
                    <h3>Enterprise Data Providers</h3>
                    <p style="margin-bottom: 12px; color: var(--text-secondary);">Connect premium data sources for enriched competitor intelligence. Configure API keys in your <code>.env</code> file.</p>
                    <div id="dataProvidersGrid" class="data-providers-grid">
                        <div class="loading">Loading provider status...</div>
                    </div>
                </div>

                <!-- Knowledge Base Import (v5.0.8) -->
                <div class="settings-card full-width icon-card" id="knowledgeBaseImport" style="border: 1px solid #4CAF50;">
                    <h3>üìÅ Knowledge Base Import</h3>
                    <p style="margin-bottom: 15px;">Import competitor data from Certify Health's knowledge base files. All imported data will be labeled as "Source: Certify Health".</p>

                    <div id="kbImportStatus" style="background: var(--glass-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 1.5em; font-weight: 600; color: var(--primary-color);" id="kbFilesCount">-</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Files Found</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5em; font-weight: 600; color: #4CAF50;" id="kbCompetitorsCount">-</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Competitors</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5em; font-weight: 600; color: #FFA726;" id="kbPendingCount">-</div>
                                <div style="font-size: 0.85em; color: var(--text-secondary);">Pending Verification</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="previewKBImport()">üëÅÔ∏è Preview Import</button>
                        <button class="btn btn-primary" onclick="runKBImport()">üì• Import All</button>
                        <button class="btn btn-secondary" onclick="navigateTo('verification')">‚úì Verification Queue</button>
                    </div>

                    <div id="kbImportResults" style="margin-top: 15px; display: none;">
                        <h4>Import Results</h4>
                        <div id="kbImportResultsContent"></div>
                    </div>
                </div>

                <div class="settings-card full-width icon-card" style="border: 1px solid var(--primary-color);">
                    <h3>ü§ñ AI Admin & Knowledge Base</h3>
                    <p>Manage AI personas, prompts, and internal knowledge sources (RAG).</p>
                    <div class="admin-actions" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="openPromptEditor()">‚úèÔ∏è Edit AI Prompts</button>
                        <button class="btn btn-secondary" onclick="openKnowledgeBase()">üìö Manage Knowledge
                            Base</button>
                    </div>
                    <div style="margin-top:16px;">
                        <h4 style="font-size:14px;margin-bottom:8px;color:#e2e8f0;">Extraction & Analysis Prompts</h4>
                        <div class="prompt-selector-inline" style="display:flex;align-items:center;gap:8px;">
                            <select id="kbPromptSelect" class="form-select" style="max-width:320px;font-size:12px;padding:4px 8px;"></select>
                            <button class="btn btn-sm btn-secondary" onclick="openPromptViewModal('kbPromptSelect','knowledge_base')" title="View/Edit Prompt" style="padding:4px 8px;font-size:11px;">‚úèÔ∏è</button>
                        </div>
                        <p style="font-size:11px;color:#64748b;margin-top:4px;">PDF, Video, and Web extraction prompts used by the AI pipeline.</p>
                    </div>
                </div>
    </div>
    </section>

    <!-- Verification Queue Page (v5.0.8) -->
    <section id="verificationPage" class="page" aria-label="Data Verification Queue">
        <div class="page-header">
            <h2>‚úì Data Verification Queue</h2>
            <p style="color: var(--text-secondary);">Review and verify data imported from Certify Health knowledge base.</p>
        </div>

        <div class="verification-controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="bulkApproveVerification()">‚úì Approve All Visible</button>
            <button class="btn btn-secondary" onclick="loadVerificationQueue()">‚Ü∫ Refresh</button>
            <button class="btn btn-secondary" onclick="navigateTo('settings')">‚Üê Back to Settings</button>
        </div>

        <div class="verification-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
            <div class="stat-card" style="background: var(--glass-bg); padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5em; font-weight: 600; color: #FFA726;" id="verifyPendingCount">0</div>
                <div style="font-size: 0.85em; color: var(--text-secondary);">Pending Review</div>
            </div>
            <div class="stat-card" style="background: var(--glass-bg); padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5em; font-weight: 600; color: #4CAF50;" id="verifyApprovedCount">0</div>
                <div style="font-size: 0.85em; color: var(--text-secondary);">Approved</div>
            </div>
        </div>

        <div id="verificationQueue" class="verification-list">
            <div class="loading">Loading verification queue...</div>
        </div>
    </section>
    </main>

    <nav class="bottom-nav">
        <a href="#" class="bottom-nav-item active" onclick="navigateTo('dashboard'); return false;">
            <span class="icon">üìä</span>
            <span>Dash</span>
        </a>
        <a href="#" class="bottom-nav-item" onclick="navigateTo('competitors'); return false;">
            <span class="icon">üè¢</span>
            <span>Comps</span>
        </a>
        <a href="#" class="bottom-nav-item" onclick="navigateTo('analytics'); return false;">
            <span class="icon">üìà</span>
            <span>Trends</span>
        </a>
        <a href="#" class="bottom-nav-item" onclick="navigateTo('settings'); return false;">
            <span class="icon">‚öôÔ∏è</span>
            <span>Settings</span>
        </a>
    </nav>
    </div>

    <!-- Modal Template -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>


    <!-- Prompt Editor Modal -->
    <div id="promptModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="modal-close" onclick="closePromptModal()">&times;</span>
            <div class="modal-header">
                <h2>Edit AI System Prompts</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Prompt</label>
                    <select id="promptKeySelector" class="form-control" onchange="loadPromptContent()">
                        <option value="dashboard_summary">Executive Summary (Full Live Data)</option>
                        <option value="dashboard_summary_concise">Executive Summary (Concise)</option>
                        <option value="chat_persona">Chat Persona</option>
                        <option value="chat_system_context">Chat System Context (Live Data + Stock)</option>
                        <option value="dashboard_agent_threat">Dashboard Agent: Threat Analysis</option>
                        <option value="dashboard_agent_executive">Dashboard Agent: Executive Summary</option>
                        <option value="data_refresh_summary">Data Refresh Summary</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>System Prompt Content</label>
                    <textarea id="promptContentEditor" class="form-control" rows="15"
                        style="font-family: monospace; font-size: 0.9em;"></textarea>
                </div>
                <div class="form-actions">
                    <div id="promptSaveStatus" style="margin-right: 15px; color: var(--success-color); display: none;">
                        Saved!</div>
                    <button class="btn btn-primary" onclick="savePromptContent()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Modal -->
    <div id="kbModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeKbModal()">&times;</span>
            <div class="modal-header">
                <h2>üìö Internal Knowledge Base</h2>
                <button class="btn btn-primary btn-sm" onclick="showAddKbItem()">+ Add New Document</button>
            </div>
            <div class="modal-body">
                <p class="text-secondary">Upload internal documents or strategy text for the AI to use as context (RAG).
                </p>

                <div id="kbList" class="kb-list"
                    style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
                    <!-- Loading... -->
                </div>

                <div id="addKbForm"
                    style="display: none; border-top: 1px solid var(--border-color); padding-top: 20px;">
                    <h3>Add New Knowledge Source</h3>

                    <!-- Upload Method Tabs -->
                    <div class="kb-upload-tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-sm kb-tab-btn active" data-tab="upload" onclick="switchKbTab('upload')">
                            üìÅ Upload File
                        </button>
                        <button class="btn btn-sm kb-tab-btn" data-tab="text" onclick="switchKbTab('text')">
                            üìù Paste Text
                        </button>
                    </div>

                    <!-- File Upload Tab -->
                    <div id="kbUploadTab" class="kb-tab-content">
                        <div id="kbDropZone" class="kb-drop-zone"
                            ondragover="handleKbDragOver(event)"
                            ondragleave="handleKbDragLeave(event)"
                            ondrop="handleKbDrop(event)">
                            <div class="drop-zone-content">
                                <div class="drop-zone-icon">üìÑ</div>
                                <p class="drop-zone-text">Drag & drop a file here, or click to browse</p>
                                <p class="drop-zone-hint">Supported: PDF, DOCX, TXT, MD, HTML (max 50MB)</p>
                                <input type="file" id="kbFileInput" style="display: none;"
                                    accept=".pdf,.docx,.txt,.md,.html" onchange="handleKbFileSelect(event)">
                            </div>
                        </div>
                        <div id="kbFilePreview" class="kb-file-preview" style="display: none;">
                            <div class="file-preview-info">
                                <span id="kbFileName" class="file-name"></span>
                                <span id="kbFileSize" class="file-size"></span>
                            </div>
                            <button class="btn btn-sm btn-secondary" onclick="clearKbFile()">‚úï Remove</button>
                        </div>
                        <div id="kbUploadProgress" class="kb-upload-progress" style="display: none;">
                            <div class="progress-bar-container">
                                <div id="kbProgressBar" class="progress-bar"></div>
                            </div>
                            <span id="kbProgressText" class="progress-text">Uploading...</span>
                        </div>
                        <div class="form-group" style="margin-top: 15px;">
                            <label>Title (optional - uses filename if blank)</label>
                            <input type="text" id="kbUploadTitle" class="form-control" placeholder="e.g. Q3 Sales Strategy">
                        </div>
                        <div class="form-row" style="display: flex; gap: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <label>Category</label>
                                <select id="kbCategory" class="form-control">
                                    <option value="general">General</option>
                                    <option value="strategy">Strategy</option>
                                    <option value="product">Product</option>
                                    <option value="sales">Sales</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="competitive">Competitive Intel</option>
                                    <option value="internal">Internal Docs</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Tags (comma-separated)</label>
                                <input type="text" id="kbTags" class="form-control" placeholder="e.g. Q3, strategy, internal">
                            </div>
                        </div>

                        <!-- v7.1 Enhanced: Date and Competitor Linking -->
                        <div class="kb-enhanced-options" style="margin-top: 15px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px;">
                            <h4 style="margin-bottom: 12px; font-size: 14px; color: var(--text-primary);">Data Reconciliation Options</h4>

                            <div class="form-row" style="display: flex; gap: 15px;">
                                <div class="form-group" style="flex: 1;">
                                    <label>Document Date</label>
                                    <input type="date" id="kbDocumentDate" class="form-control"
                                        title="When was this document created?">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label>Data Valid As Of</label>
                                    <input type="date" id="kbDataAsOfDate" class="form-control"
                                        title="When was the data in this document accurate?">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Link to Competitors (optional)</label>
                                <select id="kbLinkedCompetitors" class="form-control" multiple
                                    style="height: 80px;" title="Hold Ctrl/Cmd to select multiple">
                                    <!-- Populated dynamically -->
                                </select>
                                <small style="color: var(--text-light);">Hold Ctrl/Cmd to select multiple competitors</small>
                            </div>

                            <div class="form-row" style="display: flex; gap: 20px; margin-top: 10px;">
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="kbExtractEntities" checked>
                                    <span>Extract entities with AI</span>
                                    <span class="tooltip-icon" title="Use GPT-4 to automatically extract competitor names, products, and metrics from the document">?</span>
                                </label>
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="kbAutoLink" checked>
                                    <span>Auto-link to competitors</span>
                                    <span class="tooltip-icon" title="Automatically link extracted entities to known competitors in the database">?</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Text Paste Tab -->
                    <div id="kbTextTab" class="kb-tab-content" style="display: none;">
                        <div class="form-group">
                            <label>Title / Identifier</label>
                            <input type="text" id="kbTitle" class="form-control" placeholder="e.g. Q3 Sales Strategy">
                        </div>
                        <div class="form-group">
                            <label>Content Text</label>
                            <textarea id="kbContent" class="form-control" rows="10"
                                placeholder="Paste the text from the document here..."></textarea>
                        </div>
                    </div>

                    <div class="form-actions" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="hideAddKbForm()">Cancel</button>
                        <button id="kbSaveBtn" class="btn btn-primary" onclick="saveKbItem()">
                            <span id="kbSaveBtnText">Save Document</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FEAT-001: Alert Rule Modal -->
    <div id="alertRuleModal" class="modal" style="display: none;">
        <div class="modal-content alert-rule-modal">
            <div class="modal-header">
                <h3>Create Alert Rule</h3>
                <button class="modal-close" onclick="closeAlertRuleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="alertRuleForm" onsubmit="saveAlertRule(event)">
                    <div class="form-group">
                        <label for="ruleName">Rule Name</label>
                        <input type="text" id="ruleName" class="form-control" placeholder="e.g., High Threat Competitor Activity" required>
                    </div>

                    <div class="form-section">
                        <h4>When this happens...</h4>
                        <div class="rule-condition-builder">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ruleEvent">Event Type</label>
                                    <select id="ruleEvent" class="form-control" required>
                                        <option value="">Select event...</option>
                                        <option value="news_mention">News Mention</option>
                                        <option value="threat_change">Threat Level Change</option>
                                        <option value="funding">Funding Announcement</option>
                                        <option value="product_launch">Product Launch</option>
                                        <option value="leadership_change">Leadership Change</option>
                                        <option value="pricing_change">Pricing Change</option>
                                        <option value="acquisition">Acquisition/Merger</option>
                                        <option value="patent_filed">Patent Filed</option>
                                        <option value="employee_growth">Employee Growth > 10%</option>
                                        <option value="negative_sentiment">Negative News Sentiment</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="ruleCompetitor">For Competitor</label>
                                    <select id="ruleCompetitor" class="form-control">
                                        <option value="all">All Competitors</option>
                                        <option value="high_threat">High Threat Only</option>
                                        <option value="medium_threat">Medium+ Threat</option>
                                        <option value="watchlist">My Watchlist</option>
                                        <!-- Specific competitors populated by JS -->
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="ruleThreshold">Threshold (optional)</label>
                                <input type="text" id="ruleThreshold" class="form-control" placeholder="e.g., 3 mentions, 20% change">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Then notify via...</h4>
                        <div class="notification-channels">
                            <label class="channel-option">
                                <input type="checkbox" name="channels" value="email" checked>
                                <span class="channel-icon">üìß</span>
                                <span>Email</span>
                            </label>
                            <label class="channel-option">
                                <input type="checkbox" name="channels" value="slack">
                                <span class="channel-icon">üí¨</span>
                                <span>Slack</span>
                            </label>
                            <label class="channel-option">
                                <input type="checkbox" name="channels" value="teams">
                                <span class="channel-icon">üü¶</span>
                                <span>Teams</span>
                            </label>
                            <label class="channel-option">
                                <input type="checkbox" name="channels" value="in_app">
                                <span class="channel-icon">üîî</span>
                                <span>In-App</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Delivery Schedule</h4>
                        <div class="form-group">
                            <select id="ruleSchedule" class="form-control">
                                <option value="immediate">Immediately</option>
                                <option value="digest_hourly">Hourly Digest</option>
                                <option value="digest_daily">Daily Digest</option>
                                <option value="digest_weekly">Weekly Digest</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAlertRuleModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Rule</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Correction Modal -->
    <div id="correctionModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCorrectionModal()">&times;</span>
            <div class="modal-header">
                <h2>Correct Data</h2>
            </div>
            <div class="modal-body">
                <p>Provide a corrected value for <strong id="correctionFieldName"></strong>.</p>
                <form id="correctionForm" onsubmit="handleCorrectionSubmit(event)">
                    <input type="hidden" id="correctionCompetitorId">
                    <input type="hidden" id="correctionField">

                    <div class="form-group">
                        <label for="correctionValue">Correct Value</label>
                        <textarea id="correctionValue" class="form-control" rows="3" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="correctionReason">Reason for Change</label>
                        <select id="correctionReason" class="form-control" required>
                            <option value="Incorrect Source Data">Incorrect Source Data</option>
                            <option value="Outdated Information">Outdated Information</option>
                            <option value="Typo/Formatting Error">Typo/Formatting Error</option>
                            <option value="New Announcement">New Announcement</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCorrectionModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Correction</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Data Refresh Progress Modal -->
        <div id="refreshProgressModal" class="modal-overlay" style="display: none;">
            <div class="modal progress-modal">
                <div class="modal-header">
                    <h3>Refreshing Data...</h3>
                </div>
                <div class="modal-body">
                    <div class="progress-current">
                        <span id="progressCurrentText">Starting refresh...</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="refreshProgressBar" style="width: 0%"></div>
                    </div>
                    <div class="progress-stats">
                        <span id="progressPercent">0%</span>
                        <span id="progressCount">0 of 0 competitors</span>
                    </div>
                    <div class="progress-completed-list" id="progressCompletedList">
                        <!-- Completed competitors will be listed here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Summary Progress Modal -->
        <div id="aiSummaryProgressModal" class="modal-overlay" style="display: none;">
            <div class="modal progress-modal" style="max-width: 450px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 12px 12px 0 0;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a2 2 0 0 1 0 4h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a2 2 0 0 1 0-4h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/>
                            </svg>
                        </div>
                        <h3 style="margin: 0; color: white;">Generating AI Summary</h3>
                    </div>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <div class="progress-current" style="margin-bottom: 16px;">
                        <span id="aiProgressStepText" style="font-size: 14px; color: #475569;">Initializing...</span>
                    </div>
                    <div class="progress-bar-container" style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                        <div id="aiSummaryProgressBar" class="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #10B981, #059669); transition: width 0.3s ease;"></div>
                    </div>
                    <div class="progress-stats" style="display: flex; justify-content: space-between; margin-top: 12px; font-size: 13px; color: #64748b;">
                        <span id="aiProgressPercent">0%</span>
                        <span id="aiProgressElapsed">Elapsed: 0s</span>
                    </div>
                    <div style="margin-top: 20px; padding: 12px; background: #f8fafc; border-radius: 8px; font-size: 12px; color: #64748b;">
                        <strong>Steps:</strong>
                        <ol id="aiProgressSteps" style="margin: 8px 0 0 16px; padding: 0;">
                            <li id="step1" style="margin: 4px 0;">Loading competitor data</li>
                            <li id="step2" style="margin: 4px 0;">Loading AI configuration</li>
                            <li id="step3" style="margin: 4px 0;">Gathering knowledge base</li>
                            <li id="step4" style="margin: 4px 0;">Preparing analysis data</li>
                            <li id="step5" style="margin: 4px 0;">Generating summary with AI</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Refresh Complete Modal (Enhanced - Phase 3: Task 5.0.1-030) -->
        <div id="refreshCompleteModal" class="modal-overlay" style="display: none;">
            <div class="modal complete-modal" style="max-width: 650px;">
                <div class="modal-header success-header">
                    <span class="success-icon">&#10003;</span>
                    <h3>Data Refresh Complete!</h3>
                </div>
                <div class="modal-body">
                    <!-- Quick Stats Breakdown -->
                    <div class="refresh-summary-breakdown">
                        <div class="summary-stat-box added">
                            <span class="summary-stat-number" id="completeNewValues">0</span>
                            <span class="summary-stat-label">New Values Added</span>
                        </div>
                        <div class="summary-stat-box changed">
                            <span class="summary-stat-number" id="completeChanges">0</span>
                            <span class="summary-stat-label">Values Changed</span>
                        </div>
                        <div class="summary-stat-box" style="border-left: 3px solid var(--primary-color);">
                            <span class="summary-stat-number" id="completeTotal">0</span>
                            <span class="summary-stat-label">Competitors Scanned</span>
                        </div>
                    </div>

                    <!-- v7.1.0: Enrichment Stats (News + Stock) -->
                    <div id="enrichmentStats" style="display: none; margin-top: 8px;"></div>

                    <!-- AI Summary Section -->
                    <div id="refreshAISummarySection" class="refresh-ai-summary">
                        <div class="ai-summary-header-mini">
                            <span class="ai-icon">ü§ñ</span>
                            <span>AI Analysis of Changes</span>
                        </div>
                        <div id="refreshAISummaryContent" class="ai-summary-content-mini">
                            <span class="loading-text">Analyzing changes across your data...</span>
                        </div>
                    </div>

                    <!-- Categorized Changes Summary -->
                    <div id="categorizedChangesSection" style="margin-top: 16px; display: none;">
                        <h4 style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">Changes by Category</h4>
                        <ul class="change-categories-list" id="categorizedChangesList">
                            <!-- Populated dynamically -->
                        </ul>
                    </div>

                    <!-- Ask AI About Changes -->
                    <div id="refreshChatSection" style="margin-top: 16px; border-top: 1px solid var(--border-color); padding-top: 12px;">
                        <h4 style="font-size: 13px; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px;">üí¨ Ask AI About These Changes</h4>
                        <div id="refreshChatWidget" style="max-height: 250px;"></div>
                    </div>

                    <!-- Change Details Accordion -->
                    <div class="change-details-section">
                        <button class="accordion-toggle" onclick="toggleChangeDetails()">
                            <span>üìã View All Detailed Changes</span>
                            <span class="toggle-arrow">‚ñº</span>
                        </button>
                        <div id="changeDetailsContent" class="change-details-content" style="display: none;">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeRefreshCompleteModal()">Close</button>
                    <button class="btn btn-primary" onclick="closeRefreshCompleteModal(); showPage('changes');">View Change Log</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Sources Modal -->
    <div id="dataSourcesModal" class="data-sources-modal" onclick="closeDataSourcesModal(event)">
        <div class="data-sources-content" onclick="event.stopPropagation()">
            <div class="data-sources-header">
                <h3>üìã Data Source Attribution</h3>
                <button class="close-btn" onclick="closeDataSourcesModal()">&times;</button>
            </div>
            <div class="data-sources-body">
                <div class="sources-description">
                    Every data point is tracked with its source and confidence level based on the Admiralty Code framework.
                </div>
                <div id="dataSourcesTableContainer">
                    <p class="loading">Loading data sources...</p>
                </div>
                <div class="sources-legend">
                    <h4>Confidence Levels</h4>
                    <div class="legend-items">
                        <span class="legend-item">
                            <span class="dot confidence-high"></span>
                            High (70-100): Verified from authoritative sources
                        </span>
                        <span class="legend-item">
                            <span class="dot confidence-moderate"></span>
                            Moderate (40-69): Credible but not fully verified
                        </span>
                        <span class="legend-item">
                            <span class="dot confidence-low"></span>
                            Low (0-39): Unverified marketing claims
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PERF-007: Code Splitting / Lazy Loading -->
    <!-- Core scripts loaded with defer for non-blocking -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <!-- PDF/Excel export libraries -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
    <script src="app_v2.js?v=9" defer></script>
    <!-- ES6 Module entry point (Phase 1 migration - runs alongside app_v2.js) -->
    <script type="module" src="app.js"></script>
    <!-- WCAG 2.1 AA: Keyboard navigation manager -->
    <script src="core/keyboard.js" defer></script>
    <!-- Command Palette (Ctrl+K) -->
    <script src="components/command_palette.js" defer></script>
    <!-- Notification Center -->
    <script src="components/notification_center.js" defer></script>
    <!-- PDF/Excel Export Engine -->
    <script src="core/export.js" defer></script>

    <!-- Lazy-loaded modules - loaded on demand when needed -->
    <script>
        // PERF-007: Lazy Module Loader
        window.LazyModules = {
            loaded: {},
            loading: {},

            // Load a script dynamically
            load: function(src, name) {
                if (this.loaded[name]) {
                    return Promise.resolve();
                }
                if (this.loading[name]) {
                    return this.loading[name];
                }

                this.loading[name] = new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = true;
                    script.onload = () => {
                        this.loaded[name] = true;
                        delete this.loading[name];
                        console.log('[LazyLoad] Loaded:', name);
                        resolve();
                    };
                    script.onerror = (e) => {
                        delete this.loading[name];
                        console.error('[LazyLoad] Failed:', name, e);
                        reject(e);
                    };
                    document.body.appendChild(script);
                });

                return this.loading[name];
            },

            // Preload a script (low priority)
            preload: function(src) {
                const link = document.createElement('link');
                link.rel = 'modulepreload';
                link.href = src;
                document.head.appendChild(link);
            },

            // Load visualizations module
            loadVisualizations: function() {
                return this.load('visualizations.js?v=3', 'visualizations');
            },

            // Load analytics module
            loadAnalytics: function() {
                return this.load('enhanced_analytics.js?v=4', 'analytics');
            },

            // Load prompt manager module
            loadPromptManager: function() {
                return this.load('prompt_manager.js?v=4', 'promptManager');
            },

            // Load sales & marketing module
            loadSalesMarketing: function() {
                return this.load('sales_marketing.js?v=2', 'salesMarketing');
            }
        };

        // Load modules based on current page/section
        document.addEventListener('DOMContentLoaded', function() {
            // Load visualizations immediately (needed for dashboard)
            LazyModules.loadVisualizations();

            // Preload other modules for faster subsequent loads
            requestIdleCallback(function() {
                LazyModules.preload('enhanced_analytics.js?v=4');
                LazyModules.preload('prompt_manager.js?v=4');
                LazyModules.preload('sales_marketing.js?v=2');
            }, { timeout: 3000 });
        });

        // Intersection Observer for lazy loading page sections
        if ('IntersectionObserver' in window) {
            const lazyObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const section = entry.target;
                        const module = section.dataset.lazyModule;

                        if (module && LazyModules['load' + module]) {
                            LazyModules['load' + module]();
                        }

                        section.classList.add('loaded');
                        lazyObserver.unobserve(section);
                    }
                });
            }, { rootMargin: '200px' });

            // Observe sections with data-lazy-module attribute
            document.querySelectorAll('[data-lazy-module]').forEach(section => {
                lazyObserver.observe(section);
            });
        }

        // Fallback: requestIdleCallback polyfill
        window.requestIdleCallback = window.requestIdleCallback || function(cb) {
            return setTimeout(function() {
                cb({ timeRemaining: function() { return 50; } });
            }, 1);
        };
    </script>

    <!-- v7.0 Agent Chat Widget -->
    <script src="agent_chat_widget.js?v=7.0" defer></script>
    <script src="prompt_manager.js?v=7.0" defer></script>
</body>

</html>