# Certify Intel Database Migrations

REL-009: Alembic-based database migration system.

## Quick Start

```bash
# Navigate to backend directory
cd backend

# Create a new migration (auto-detect changes)
alembic revision --autogenerate -m "description of changes"

# Apply all pending migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# View current revision
alembic current

# View migration history
alembic history
```

## Common Commands

| Command | Description |
|---------|-------------|
| `alembic upgrade head` | Apply all pending migrations |
| `alembic downgrade -1` | Rollback one migration |
| `alembic downgrade base` | Rollback all migrations |
| `alembic current` | Show current database revision |
| `alembic history` | Show all migrations |
| `alembic revision -m "msg"` | Create empty migration |
| `alembic revision --autogenerate -m "msg"` | Auto-generate migration from model changes |

## Migration Naming Convention

Migrations are named with timestamps:
```
YYYYMMDD_HHMM_revision_slug.py
```

Example: `20260128_1430_0002_add_new_feature.py`

## Best Practices

1. **Always test migrations** on a copy of production data before deploying
2. **Keep migrations small** - one logical change per migration
3. **Write downgrades** - ensure all upgrades can be reversed
4. **Review autogenerated migrations** - autogenerate is not perfect

## Environment Variables

- `CERTIFY_DATABASE_URL`: Override database URL
- `DATABASE_URL`: Alternative database URL variable

## SQLite Notes

SQLite has limited ALTER TABLE support. This configuration uses:
- `render_as_batch=True` in env.py to handle SQLite limitations
- Batch mode recreates tables for unsupported operations

## Directory Structure

```
alembic/
  env.py              # Alembic environment configuration
  script.py.mako      # Migration script template
  versions/           # Migration scripts
    20260128_0001_initial_schema.py   # Initial baseline
```
